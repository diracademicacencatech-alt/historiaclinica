<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <style>
        /* CONFIGURACI칍N DE P츼GINA PROFESIONAL */
        @page {
            size: letter;
            /* Margen superior amplio (4cm) para dar espacio al header fijo */
            margin: 4cm 1.5cm 2cm 1.5cm;
            
            @bottom-right {
                content: "P치gina " counter(page);
                font-size: 8pt;
                color: #999;
            }
        }

        :root {
            --sm-primary: #236e7b; /* Tu color verde azulado base */
            --sm-light: #eef2f7;
        }

        body {
            font-family: 'Helvetica', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #333;
            background: white;
        }

        /* HEADER REPETITIVO (EST츼TICO) */
        .header-container {
            position: fixed; /* Clave para que se repita en cada hoja */
            top: -3.5cm;     /* Posicionado dentro del margen superior de la p치gina */
            left: 0;
            right: 0;
            display: table;
            width: 100%;
            border-bottom: 2px solid var(--sm-primary);
            padding-bottom: 10px;
            height: 3cm;
        }
        
        .header-logo {
            display: table-cell;
            vertical-align: middle;
            width: 30%;
        }
        
        .header-info {
            display: table-cell;
            vertical-align: middle;
            text-align: right;
            width: 70%;
        }
        
        .header-logo img {
            max-height: 55px;
            width: auto;
        }
        
        .software-name {
            font-size: 12pt;
            font-weight: bold;
            color: var(--sm-primary);
            margin: 0;
            text-transform: uppercase;
        }
        
        .document-type {
            font-size: 9pt;
            font-weight: bold;
            color: var(--sm-primary);
            margin: 0;
            letter-spacing: 1px;
        }

        /* CONTENEDOR PRINCIPAL */
        .content {
            margin-top: 10px;
        }

        /* SECCIONES UNIFICADAS */
        .section {
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            page-break-inside: avoid;
        }
        .section-title {
            background-color: var(--sm-primary);
            color: white;
            padding: 4px 10px;
            font-weight: bold;
            font-size: 10pt;
            text-transform: uppercase;
        }

        /* TABLA DE DATOS (GRID) */
        .content-grid {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }
        .row { display: table-row; }
        .cell {
            display: table-cell;
            padding: 6px 10px;
            border: 1px solid #f0f0f0;
            vertical-align: top;
            width: 33.3%;
        }
        .cell strong {
            display: block;
            font-size: 7.5pt;
            color: var(--sm-primary);
            text-transform: uppercase;
        }

        /* AREAS DE TEXTO */
        .text-area {
            padding: 8px 10px;
            background-color: #fafafa;
            border-bottom: 1px solid #eee;
        }
        .text-area b { font-size: 8pt; color: #555; text-transform: uppercase; }

        /* TABLAS (MEDICAMENTOS Y LABS) */
        table { width: 100%; border-collapse: collapse; }
        th { 
            background-color: var(--sm-light); 
            color: var(--sm-primary);
            text-align: left; 
            padding: 6px 10px; 
            font-size: 8.5pt; 
            border-bottom: 2px solid var(--sm-primary); 
        }
        td { padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 9pt; }

        /* SIGNOS VITALES */
        .vitals-box {
            display: table;
            width: 100%;
            text-align: center;
            background: #f8f9fa;
        }
        .vital-item {
            display: table-cell;
            padding: 8px;
            border-right: 1px solid #eee;
        }
        .vital-item small { display: block; font-size: 7pt; color: #666; }
        .vital-item span { font-weight: bold; font-size: 10pt; color: var(--sm-primary); }

        .footer { text-align: center; font-size: 8pt; color: #aaa; margin-top: 20px; }
        .sub-header-table { background: var(--sm-light); padding: 4px 10px; font-weight: bold; font-size: 8.5pt; color: var(--sm-primary); border-top: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-logo">
            <img src="{{ url_for('static', filename='img/logo.png', _external=True) }}" alt="Logo">
            <div class="software-name">Software SM</div>
        </div>
        <div class="header-info">
            <h1 style="margin:0; color: var(--sm-primary); font-size: 18pt;">HISTORIA CL칈NICA</h1>
            <p class="document-type">COPIA CONTROLADA</p>
        </div>
    </div>

    <div class="content">
        <div class="section">
            <div class="section-title">1. Identificaci칩n y Datos de Ingreso</div>
            <div class="content-grid">
                <div class="row">
                    <div class="cell"><strong>Paciente</strong>{{ historia.nombre_paciente }}</div>
                    <div class="cell"><strong>Documento</strong>{{ historia.paciente.numero if historia.paciente else 'N/A' }}</div>
                    <div class="cell"><strong>Ingreso</strong>{{ historia.numero_ingreso }}</div>
                </div>
                <div class="row">
                    <div class="cell"><strong>Edad / Sexo</strong>{{ historia.edad }} a침os / {{ historia.sexo }}</div>
                    <div class="cell"><strong>Fecha Nacimiento</strong>{{ historia.fecha_nacimiento.strftime('%d/%m/%Y') if historia.fecha_nacimiento else 'N/A' }}</div>
                    <div class="cell"><strong>Servicio</strong>{{ historia.servicio_hospitalario or 'N/A' }}</div>
                </div>
                <div class="row">
                    <div class="cell"><strong>Fecha Ingreso</strong>{{ historia.fecha_registro.strftime('%d/%m/%Y %H:%M') if historia.fecha_registro else 'N/A' }}</div>
                    <div class="cell"><strong>Cama</strong>{{ historia.paciente.cama if (historia.paciente and historia.paciente.cama) else 'N/A' }}</div>
                    <div class="cell"><strong>Procedencia</strong>{{ historia.procedencia or 'N/A' }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2. Diagn칩stico y Evaluaci칩n (SOAP)</div>
            <div class="text-area">
                <b>Diagn칩stico Principal (CIE10):</b> {{ historia.cie10_principal }} 
                {% if diag_cie10 %} - {{ diag_cie10.nombre }}{% endif %}
            </div>
            <div class="text-area"><b>[S] Subjetivo:</b><br>{{ historia.subjetivos or 'No registra' }}</div>
            <div class="text-area"><b>[O] Objetivo:</b><br>{{ historia.objetivos or 'No registra' }}</div>
            <div class="text-area"><b>[A] An치lisis:</b><br>{{ historia.analisis or 'No registra' }}</div>
            <div class="text-area"><b>[P] Plan:</b><br>{{ historia.plan or 'No registra' }}</div>
        </div>
        
        <div class="section">
            <div class="section-title">2.1 Plan Farmacol칩gico de Ingreso</div>
            {% if medicamentos %}
            <table>
                <thead>
                    <tr>
                        <th style="width: 35%;">Medicamento</th>
                        <th style="width: 15%;">Dosis</th>
                        <th style="width: 15%;">Frecuencia</th>
                        <th style="width: 20%;">Cant. Recetada</th>
                        <th style="width: 15%;">V칤a</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in medicamentos %}
                    <tr>
                        <td><b>{{ m.nombre }}</b></td>
                        <td>{{ m.dosis }}</td>
                        <td>Cada {{ m.frecuencia }}h</td>
                        <td><b>{{ m.cantidad }}</b> {{ m.unidad }}</td>
                        <td>{{ m.via }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-area">No se registraron medicamentos en el ingreso.</div>
            {% endif %}
        </div>
         
        {% if historia.signos_vitales %}
        <div class="section">
            <div class="section-title">3. Signos Vitales de Ingreso</div>
            <div class="vitals-box">
                <div class="vital-item"><small>F.C (LPM)</small><span>{{ historia.signos_vitales.frecuencia_cardiaca or '--' }}</span></div>
                <div class="vital-item"><small>F.R (RPM)</small><span>{{ historia.signos_vitales.frecuencia_respiratoria or '--' }}</span></div>
                <div class="vital-item"><small>T.A (mmHg)</small><span>{{ historia.signos_vitales.tension_arterial or '--' }}</span></div>
                <div class="vital-item"><small>Temp (춿C)</small><span>{{ historia.signos_vitales.temperatura or '--' }}</span></div>
                <div class="vital-item"><small>SatO2 (%)</small><span>{{ historia.signos_vitales.saturometria or '--' }}</span></div>
                <div class="vital-item"><small>IMC</small><span>{{ (historia.signos_vitales.imc|float|round(1)) if historia.signos_vitales.imc else '--' }}</span></div>
            </div>
            <div class="content-grid">
                <div class="row">
                    <div class="cell"><strong>Escala Dolor</strong>{{ historia.signos_vitales.escala_dolor or '0' }}/10</div>
                    <div class="cell"><strong>Glucometr칤a</strong>{{ historia.signos_vitales.glucometria or '--' }} mg/dL</div>
                    <div class="cell"><strong>Peso / Talla</strong>{{ historia.signos_vitales.peso or '--' }}kg / {{ historia.signos_vitales.talla or '--' }}m</div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="section">
            <div class="section-title">4. Antecedentes M칠dicos</div>
            <div class="content-grid">
                <div class="row">
                    <div class="cell"><strong>Patol칩gicos</strong>{{ historia.antecedentes_medicos or 'Negativo' }}</div>
                    <div class="cell"><strong>Quir칰rgicos</strong>{{ historia.antecedentes_quirurgicos or 'Negativo' }}</div>
                </div>
                <div class="row">
                    <div class="cell"><strong>Farmacol칩gicos</strong>{{ historia.antecedentes_farmacologicos or 'Negativo' }}</div>
                    <div class="cell"><strong>T칩xicos</strong>{{ historia.antecedentes_toxicos or 'Negativo' }}</div>
                </div>
                <div class="row">
                    <div class="cell"><strong>Alergias</strong>{{ historia.descripcion_alergias if historia.tiene_alergias == 'si' else 'Negativo' }}</div>
                    <div class="cell"><strong>Ginecobst칠tricos</strong>{{ historia.antecedentes_ginecobstetricos or 'N/A' }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">5. Seguridad del Paciente (Riesgos)</div>
            <div class="text-area"><b>Riesgo Ca칤das (Downton):</b> {{ historia.riesgo_caidas_dowton or 'No evaluado' }}</div>
            <div class="text-area"><b>Riesgo UPP (Braden):</b> {{ historia.riesgo_upp_braden or 'No evaluado' }}</div>
            <div class="text-area"><b>Evaluaci칩n General:</b> {{ historia.riesgos_evaluacion or 'Sin observaciones' }}</div>
        </div>

        {% if ordenes_con_meds %}
        <div style="page-break-before: always;"></div>
        <div class="header"><h1>칍rdenes M칠dicas</h1></div>

        {% for item in ordenes_con_meds %}
        <div class="section" style="border: 1.5px solid var(--sm-primary);">
            <div class="section-title">
                Orden #{{ item.orden.id }} - {{ item.orden.fecha_registro.strftime('%d/%m/%Y %H:%M') if item.orden.fecha_registro else 'S/F' }}
            </div>
            
            {% if item.orden.indicaciones_medicas %}
            <div class="text-area"><b>Indicaciones:</b> {{ item.orden.indicaciones_medicas }}</div>
            {% endif %}

            {% if item.medicamentos %}
            <div class="sub-header-table">游눍 MEDICAMENTOS REGISTRADOS</div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 35%;">Medicamento</th>
                        <th style="width: 15%;">Dosis</th>
                        <th style="width: 15%;">Frecuencia</th>
                        <th style="width: 20%;">Cant.</th> <th style="width: 15%;">V칤a</th>
                    </tr>
                </thead>
                <tbody>
                    {% for med in item.medicamentos %}
                    <tr>
                        <td><b>{{ med.nombre }}</b></td>
                        <td>{{ med.dosis }}</td>
                        <td>{{ med.frecuencia }}</td>
                        <td>{{ med.cantidad }}</td> <td>{{ med.via }}</td> </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {% if item.laboratorios %}
            <div class="sub-header-table">游댧 LABORATORIOS Y EX츼MENES</div>
            <table>
                <thead>
                    <tr>
                        <th>Descripci칩n del Examen</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lab in item.laboratorios %}
                    <tr>
                        <td style="width: 70%;"><b>{{ lab.nombre }}</b></td>
                        <td style="font-style: italic; color: #555;">{{ lab.estado }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        <div class="footer">
            Documento generado autom치ticamente - {{ now.strftime('%d/%m/%Y %H:%M') }}
        </div>
    </div>

</body>
</html>