<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Cl√≠nica #{{ historia.numero_historia }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .page { page-break-after: always; padding: 20px; }
        .page-break { page-break-after: always; }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #0056b3;
            margin-bottom: 30px;
            padding-bottom: 15px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #0056b3;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            color: #666;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #0056b3;
            padding: 10px 15px;
            margin: 20px 0 15px 0;
            border-radius: 4px;
        }
        
        .section-title.yellow { background-color: #ffc107; color: #000; }
        .section-title.red { background-color: #dc3545; color: white; }
        .section-title.blue { background-color: #0dcaf0; color: #000; }
        
        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .info-item {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .info-item strong {
            display: block;
            color: #0056b3;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .info-item p {
            margin: 0;
            font-size: 12px;
            color: #333;
        }
        
        .info-text {
            border: 1px solid #ddd;
            padding: 12px;
            background: #f9f9f9;
            min-height: 60px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .soapie-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .soapie-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .soapie-header {
            background: #e9ecef;
            padding: 8px 12px;
            font-weight: bold;
            color: #0056b3;
            font-size: 12px;
        }
        
        .soapie-content {
            padding: 10px;
            min-height: 80px;
            font-size: 11px;
            color: #333;
            background: #f9f9f9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11px;
        }
        
        table thead {
            background: #0056b3;
            color: white;
        }
        
        table th {
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #0056b3;
        }
        
        table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }
        
        table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-danger { background: #dc3545; color: white; }
        .badge-success { background: #28a745; color: white; }
        
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vital-card {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .vital-card strong {
            display: block;
            font-size: 10px;
            color: #0056b3;
            margin-bottom: 5px;
        }
        
        .vital-card .value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .antecedentes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .antecedente-item {
            border: 1px solid #ffc107;
            background: #fffacd;
            padding: 12px;
            border-radius: 4px;
        }
        
        .antecedente-item strong {
            display: block;
            color: #856404;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .antecedente-item p {
            margin: 0;
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        
        .riesgo-item {
            border: 1px solid #dc3545;
            background: #f8d7da;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        
        .riesgo-item strong {
            color: #721c24;
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .riesgo-item p {
            margin: 0;
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        
        .alergia-item {
            border: 1px solid #0dcaf0;
            background: #cfe2ff;
            padding: 12px;
            border-radius: 4px;
        }
        
        .alergia-item strong {
            color: #084298;
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .alergia-item p {
            margin: 0;
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        
        hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }
        
        .footer {
            text-align: center;
            font-size: 10px;
            color: #999;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>

<!-- P√ÅGINA 1: PORTADA Y DATOS B√ÅSICOS -->
<div class="page">
    <div class="header">
        <h1>üìã HISTORIA CL√çNICA</h1>
        <p>N¬∞ {{ historia.numero_historia }} | N¬∞ Ingreso: {{ historia.numero_ingreso }}</p>
    </div>

    <!-- PACIENTE -->
    <div class="section-title">Datos del Paciente</div>
    <div class="info-row">
        <div class="info-item">
            <strong>Nombre</strong>
            <p>{{ historia.nombre_paciente }}</p>
        </div>
        <div class="info-item">
            <strong>Documento</strong>
            <p>{{ historia.paciente.numero if historia.paciente else 'N/A' }}</p>
        </div>
    </div>

    <div class="info-row">
        <div class="info-item">
            <strong>Edad</strong>
            <p>{{ historia.edad }} a√±os</p>
        </div>
        <div class="info-item">
            <strong>Sexo</strong>
            <p>{{ historia.sexo }}</p>
        </div>
    </div>

    <div class="info-row">
        <div class="info-item">
            <strong>Fecha Nacimiento</strong>
            <p>{{ historia.fecha_nacimiento.strftime('%d/%m/%Y') if historia.fecha_nacimiento else 'N/A' }}</p>
        </div>
        <div class="info-item">
            <strong>Fecha Ingreso</strong>
            <p>{{ fecha_ingreso_local.strftime('%d/%m/%Y %H:%M') if fecha_ingreso_local else 'N/A' }}</p>
        </div>
    </div>

    <!-- INGRESO -->
    <div class="section-title">Informaci√≥n de Ingreso</div>
    <div class="info-row">
        <div class="info-item">
            <strong>Servicio</strong>
            <p>{{ historia.servicio_hospitalario }}</p>
        </div>
        <div class="info-item">
            <strong>Cama</strong>
            <p>{{ historia.paciente.cama if historia.paciente and historia.paciente.cama else 'N/A' }}</p>
        </div>
    </div>

    <div class="info-row">
        <div class="info-item">
            <strong>R√©gimen</strong>
            <p>{{ historia.regimen }}</p>
        </div>
        <div class="info-item">
            <strong>Plan de Beneficios</strong>
            <p>{{ historia.plan_beneficios }}</p>
        </div>
    </div>

    <div class="info-row">
        <div class="info-item">
            <strong>Tel√©fono</strong>
            <p>{{ historia.telefono }}</p>
        </div>
        <div class="info-item">
            <strong>Procedencia</strong>
            <p>{{ historia.procedencia }}</p>
        </div>
    </div>

    <!-- RESPONSABLE -->
    <div class="section-title">Responsable y Familia</div>
    <div class="info-row">
        <div class="info-item">
            <strong>Responsable</strong>
            <p>{{ historia.acudiente_responsable }}</p>
        </div>
        <div class="info-item">
            <strong>Tel Responsable</strong>
            <p>{{ historia.telefono_responsable }}</p>
        </div>
    </div>

    <div class="info-row">
        <div class="info-item">
            <strong>Padre</strong>
            <p>{{ historia.nombre_padre }}</p>
        </div>
        <div class="info-item">
            <strong>Madre</strong>
            <p>{{ historia.nombre_madre }}</p>
        </div>
    </div>

    <div class="footer">
        Generado el {{ now.strftime('%d/%m/%Y %H:%M') }}
    </div>
</div>

<!-- P√ÅGINA 2: DIAGN√ìSTICO Y SOAPIE -->
<div class="page page-break">
    <div class="header">
        <h1>Evaluaci√≥n Cl√≠nica</h1>
    </div>

    <!-- DIAGN√ìSTICO CIE-10 -->
    <div class="section-title">Diagn√≥stico Principal (CIE-10)</div>
    <div class="info-text">
        <strong>C√≥digo:</strong> {{ historia.cie10_principal }}
        {% if diag_cie10 %}<br><strong>Descripci√≥n:</strong> {{ diag_cie10.nombre }}{% endif %}
    </div>

    <!-- SOAPIE -->
    <div class="section-title">SOAPIE (Evaluaci√≥n Cl√≠nica)</div>
    
    <div class="soapie-container">
        <div class="soapie-item">
            <div class="soapie-header">üìã Subjetivo</div>
            <div class="soapie-content">{{ historia.subjetivos or 'N/A' }}</div>
        </div>
        <div class="soapie-item">
            <div class="soapie-header">üìä Objetivo</div>
            <div class="soapie-content">{{ historia.objetivos or 'N/A' }}</div>
        </div>
    </div>

    <div class="soapie-container">
        <div class="soapie-item">
            <div class="soapie-header">üîç An√°lisis</div>
            <div class="soapie-content">{{ historia.analisis or 'N/A' }}</div>
        </div>
        <div class="soapie-item">
            <div class="soapie-header">üìã Plan</div>
            <div class="soapie-content">{{ historia.plan or 'N/A' }}</div>
        </div>
    </div>

    <!-- MEDICAMENTOS DE INGRESO -->
    {% if medicamentos %}
    <div class="section-title">Medicamentos de Ingreso</div>
    <table>
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Dosis</th>
                <th>Frecuencia</th>
                <th>V√≠a de Administraci√≥n</th>
            </tr>
        </thead>
        <tbody>
            {% for med in medicamentos %}
            <tr>
                <td><strong>{{ med.codigo }}</strong></td>
                <td>{{ med.dosis or 'N/A' }}</td>
                <td>{{ med.frecuencia or 'N/A' }}</td>
                <td>{{ med.via_administracion or 'N/A' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <div class="footer">
        P√°gina 2
    </div>
</div>

<!-- P√ÅGINA 3: SIGNOS VITALES -->
{% if historia.signos_vitales %}
<div class="page page-break">
    <div class="header">
        <h1>Signos Vitales de Ingreso</h1>
    </div>

    <div class="vitals-grid">
        <div class="vital-card">
            <strong>FC (lpm)</strong>
            <div class="value">{{ historia.signos_vitales.frecuencia_cardiaca or 'N/A' }}</div>
        </div>
        <div class="vital-card">
            <strong>FR (rpm)</strong>
            <div class="value">{{ historia.signos_vitales.frecuencia_respiratoria or 'N/A' }}</div>
        </div>
        <div class="vital-card">
            <strong>TA (mmHg)</strong>
            <div class="value">{{ historia.signos_vitales.tension_arterial or 'N/A' }}</div>
        </div>
        <div class="vital-card">
            <strong>T¬∞ (¬∞C)</strong>
            <div class="value">{{ historia.signos_vitales.temperatura or 'N/A' }}</div>
        </div>
        <div class="vital-card">
            <strong>SatO2 (%)</strong>
            <div class="value">{{ historia.signos_vitales.saturometria or 'N/A' }}</div>
        </div>
        <div class="vital-card">
            <strong>FiO2 (%)</strong>
            <div class="value">{{ historia.signos_vitales.fi02 or 'N/A' }}</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        <div class="info-item">
            <strong>Dolor (0-10)</strong>
            <p style="font-size: 18px; font-weight: bold; color: #dc3545;">{{ historia.signos_vitales.escala_dolor or 'N/A' }}</p>
        </div>
        <div class="info-item">
            <strong>Glucometr√≠a (mg/dl)</strong>
            <p style="font-size: 16px; font-weight: bold;">{{ historia.signos_vitales.glucometria or 'N/A' }}</p>
        </div>
        <div class="info-item">
            <strong>IMC</strong>
            <p style="font-size: 16px; font-weight: bold;">{{ (historia.signos_vitales.imc|float|round(1)) if historia.signos_vitales.imc else 'N/A' }}</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
        <div class="info-item">
            <strong>Peso (kg)</strong>
            <p>{{ historia.signos_vitales.peso or 'N/A' }}</p>
        </div>
        <div class="info-item">
            <strong>Talla (m)</strong>
            <p>{{ historia.signos_vitales.talla or 'N/A' }}</p>
        </div>
    </div>

    <div class="footer">
        P√°gina 3
    </div>
</div>
{% endif %}

<!-- P√ÅGINA 4: ANTECEDENTES -->
<div class="page page-break">
    <div class="section-title yellow">Antecedentes M√©dicos</div>

    <div class="antecedentes-grid">
        <div class="antecedente-item">
            <strong>M√©dicos</strong>
            <p>{{ historia.antecedentes_medicos or 'No registrado' }}</p>
        </div>
        <div class="antecedente-item">
            <strong>Farmacol√≥gicos</strong>
            <p>{{ historia.antecedentes_farmacologicos or 'No registrado' }}</p>
        </div>
    </div>

    <div class="antecedentes-grid">
        <div class="antecedente-item">
            <strong>Quir√∫rgicos</strong>
            <p>{{ historia.antecedentes_quirurgicos or 'No registrado' }}</p>
        </div>
        <div class="antecedente-item">
            <strong>T√≥xicos</strong>
            <p>{{ historia.antecedentes_toxicos or 'No registrado' }}</p>
        </div>
    </div>

    <div class="antecedentes-grid">
        <div class="antecedente-item">
            <strong>Al√©rgicos</strong>
            <p>{{ historia.antecedentes_alergicos or 'No registrado' }}</p>
        </div>
        <div class="antecedente-item">
            <strong>Ginecobst√©tricos</strong>
            <p>{{ historia.antecedentes_ginecobstetricos or 'No registrado' }}</p>
        </div>
    </div>

    <div class="footer">
        P√°gina 4
    </div>
</div>

<!-- P√ÅGINA 5: RIESGOS Y ALERGIAS -->
<div class="page page-break">
    <div class="section-title red">Valoraci√≥n de Riesgos</div>

    <div class="riesgo-item">
        <strong>Riesgos General</strong>
        <p>{{ historia.riesgos_general or 'No registrado' }}</p>
    </div>

    <div class="riesgo-item">
        <strong>Riesgo de Ca√≠das (Escala Dowton)</strong>
        <p>{{ historia.riesgo_caidas_dowton or 'No registrado' }}</p>
    </div>

    <div class="riesgo-item">
        <strong>Riesgo de UPP (Escala Braden)</strong>
        <p>{{ historia.riesgo_upp_braden or 'No registrado' }}</p>
    </div>

    <div class="riesgo-item">
        <strong>Evaluaci√≥n General</strong>
        <p>{{ historia.riesgos_evaluacion or 'No registrado' }}</p>
    </div>

    <hr>

    <div class="section-title blue">Alergias</div>

    <div class="alergia-item">
        <strong>¬øTiene alergias conocidas?</strong>
        <p>
            {% if historia.tiene_alergias == 'si' %}
                <span class="badge badge-danger">S√ç</span>
            {% else %}
                <span class="badge badge-success">NO</span>
            {% endif %}
        </p>
    </div>

    {% if historia.tiene_alergias == 'si' and historia.descripcion_alergias %}
    <div class="alergia-item" style="margin-top: 15px; background: #fff3cd; border-color: #ffc107;">
        <strong>Descripci√≥n de Alergias</strong>
        <p>{{ historia.descripcion_alergias }}</p>
    </div>
    {% endif %}

    <div class="footer">
        P√°gina 5
    </div>
</div>

<!-- P√ÅGINA 6: √ìRDENES M√âDICAS -->
{% if ordenes_con_meds %}
<div class="page page-break">
    <div class="header">
        <h1>√ìrdenes M√©dicas</h1>
    </div>

    {% for item in ordenes_con_meds %}
    <div style="border: 2px solid #0056b3; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
        <h4 style="color: #0056b3; margin-bottom: 10px;">Orden #{{ item.orden.id }}</h4>
        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
            <strong>Fecha:</strong> {{ item.orden.fecha_orden.strftime('%d/%m/%Y %H:%M') if item.orden.fecha_orden else 'N/A' }}
        </p>

        {% if item.medicamentos %}
        <table>
            <thead>
                <tr>
                    <th>Medicamento</th>
                    <th>Dosis</th>
                    <th>Frecuencia</th>
                    <th>V√≠a</th>
                </tr>
            </thead>
            <tbody>
                {% for med in item.medicamentos %}
                <tr>
                    <td><strong>{{ med.codigo }}</strong></td>
                    <td>{{ med.dosis or 'N/A' }}</td>
                    <td>{{ med.frecuencia or 'N/A' }}</td>
                    <td>{{ med.via_administracion or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endfor %}

    <div class="footer">
        P√°gina 6
    </div>
</div>
{% endif %}

</body>
</html>
