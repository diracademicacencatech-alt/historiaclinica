{% extends 'base.html' %}
{% block title %}Historias Cl√≠nicas{% endblock %}

{% block content %}
<style>
    /* Aplicando colores de la base */
    :root {
        --sm-primary: #236e7b;    /* verde azulado */
        --sm-text-main: #0b6169;   /* verde oscuro */
        --sm-bg-card: #f0e7d8;     /* crema interior */
    }

    h1, h2 { 
        color: var(--sm-primary); 
        font-weight: 800; 
        text-align: center;
        text-transform: uppercase;
        margin-bottom: 20px;
    }

    /* Estilo de la Tarjeta (Contenedor Interior) */
    .card-custom { 
        background-color: var(--sm-bg-card);
        max-width: 900px; 
        margin: 0 auto 25px auto; 
        padding: 20px; 
        border: 2px solid var(--sm-primary); 
        border-radius: 15px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    }

    .card-title-custom { 
        font-size: 1.2rem; 
        color: var(--sm-text-main);
        margin-bottom: 15px; 
        font-weight: bold; 
        text-align: center;
    }

    /* Botones con colores de la base */
    .btn-sm-primary { 
        background-color: var(--sm-primary); 
        color: white !important; 
        border: none;
        transition: 0.3s;
    }
    .btn-sm-primary:hover { background-color: #0b6169; }

    .btn-sm-outline { 
        border: 2px solid var(--sm-primary); 
        color: var(--sm-primary) !important; 
        background: transparent;
        font-weight: bold;
    }
    .btn-sm-outline:hover { background: var(--sm-primary); color: white !important; }

    /* Buscador */
    .search-box { max-width: 700px; margin: 0 auto 20px auto; }
    .search-box label { color: var(--sm-text-main); font-weight: bold; }
    .search-box input { 
        border: 2px solid var(--sm-primary); 
        border-radius: 10px; 
        padding: 12px;
    }

    /* Tablas Responsivas */
    .table-container {
        background: white;
        border-radius: 10px;
        padding: 10px;
        overflow-x: auto; /* Evita que se salga en m√≥vil */
    }

    table { width: 100%; border-collapse: collapse; }
    th { 
        background-color: var(--sm-primary) !important; 
        color: white !important; 
        padding: 12px; 
    }
    td { padding: 12px; border-bottom: 1px solid #eee; color: var(--sm-text-main); }

    .btn-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 15px; 
    }
</style>

<div class="container">
    <h1>üìã Historias Cl√≠nicas</h1>

    <div class="card-custom">
        <div class="card-title-custom"></div>
        <div class="btn-grid">
            <a href="{{ url_for('pacientes.nuevo_ingreso') }}" class="btn btn-sm-primary py-2">
                üÜï Nuevo Ingreso
            </a>
            <a href="{{ url_for('pacientes.carga_masiva') }}" class="btn btn-sm-outline py-2">
                üì• Carga Masiva
            </a>
        </div>
    </div>

    <div class="search-box">
        <label for="pacienteBusqueda">üîç Buscar por Nombre o ID:</label>
        <input type="text" id="pacienteBusqueda" class="form-control" 
               placeholder="Escriba aqu√≠ para buscar..." list="listaPacientes">
        <datalist id="listaPacientes">
            {% for p in pacientes %}
            <option value="{{ p.id }} - {{ p.nombre }} ({{ p.numero }})">
            {% endfor %}
        </datalist>
    </div>

    <div class="table-container shadow-sm mt-4">
        <table class="table table-hover" id="tablaHistorias">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Paciente</th>
                    <th>Documento</th>
                    <th>Fecha</th>
                    <th>R√©gimen</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6" class="text-center text-muted">Use el buscador para ver las historias</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="text-center mt-5">
        <a href="{{ url_for('menu.inicio') }}" class="btn btn-sm-outline px-4">
            ‚Üê Volver al Men√∫ Principal
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('pacienteBusqueda');
    const tbody = document.querySelector('#tablaHistorias tbody');

    const urlPdfBase = "/pacientes/historias/libro/__ID__/pdf";
    const urlOrdenBase = "/pacientes/historias/__ID__/orden_medica";

    function getPacienteId(valor) {
        const partes = (valor || '').split('-');
        const id = parseInt(partes[0]);
        return isNaN(id) ? null : id;
    }

    input.addEventListener('change', function () {
        const pacienteId = getPacienteId(input.value);
        if (!pacienteId) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Seleccione un paciente v√°lido.</td></tr>';
            return;
        }

        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';

        fetch("{{ url_for('pacientes.historias_por_paciente') }}?paciente_id=" + pacienteId)
            .then(resp => resp.json())
            .then(data => {
                tbody.innerHTML = '';
                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Este paciente no tiene historias cl√≠nicas.</td></tr>';
                    return;
                }

                data.forEach(h => {
                    const tr = document.createElement('tr');
                    const urlVerHistoria = `/pacientes/historias/libro/${h.id}/ver`;
                    const urlPdf = urlPdfBase.replace('__ID__', h.id);
                    const urlOrden = urlOrdenBase.replace('__ID__', h.id);

                    tr.innerHTML = `
                        <td><strong>${h.id}</strong></td>
                        <td>${h.nombre}</td>
                        <td>${h.numero}</td>
                        <td>${h.fecha_registro}</td>
                        <td><span class="badge bg-light text-dark border">${h.regimen}</span></td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-sm btn-outline-info" href="${urlVerHistoria}">üëÅÔ∏èVer HC</a>
                                <a class="btn btn-sm btn-primary" href="${urlPdf}" target="_blank">üìÑGenerar PDF</a>
                                <a class="btn btn-sm btn-success" href="${urlOrden}">‚ûï A√±adir Orden</a>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar datos.</td></tr>';
            });
    });
});
</script>
{% endblock %}