<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear Registro de Enfermería</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-4">
  <h2>Crear Registro de Enfermería</h2>

  <form method="POST" action="{{ url_for('enfermeria.crear', paciente_id=paciente_id) }}">
    <input type="hidden" name="paciente_id" value="{{ paciente_id }}">

    <!-- Historia clínica -->
    <div class="mb-3">
      <label for="historia_clinica_id" class="form-label">Historia clínica</label>
      <select id="historia_clinica_id" name="historia_clinica_id" class="form-select" required>
        <option value="">Seleccione...</option>
        {% for h in historias %}
          <option value="{{ h.id }}">
            {{ h.numero_historia }} - {{ h.fecha_registro }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- ================= SIGNOS VITALES ================= -->
    <fieldset class="mb-3 border rounded p-3">
      <legend class="w-auto px-2">Signos Vitales</legend>
      <div class="row">
        <div class="col">
          <label for="ta" class="form-label">t/a</label>
          <input type="text" id="ta" name="ta" class="form-control"
                 pattern="^\d{2,3}\/\d{2,3}$" placeholder="120/80">
        </div>
        <div class="col">
          <label for="fc" class="form-label">fc</label>
          <input type="number" id="fc" name="fc" class="form-control" min="0">
        </div>
        <div class="col">
          <label for="fr" class="form-label">fr</label>
          <input type="number" id="fr" name="fr" class="form-control" min="0">
        </div>
        <div class="col">
          <label for="temp" class="form-label">t°</label>
          <input type="text" id="temp" name="temp" class="form-control"
                 pattern="^\d{1,2}([.,]\d{1,2})?$" placeholder="36.5">
        </div>
        <div class="col">
          <label for="so2" class="form-label">SO2</label>
          <input type="number" id="so2" name="so2" class="form-control" min="0" max="100">
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-3">
          <label for="control_glicemia" class="form-label">Control de Glicemia</label>
          <input type="number" min="0" step="any" id="control_glicemia"
                 name="control_glicemia" class="form-control" />
        </div>
      </div>
    </fieldset>

    <!-- ================= LÍQUIDOS ================= -->
    <div class="row mb-3">
      <!-- Administrados -->
      <div class="col-md-6">
        <fieldset class="border rounded p-3 h-100 mb-3">
          <legend class="w-auto px-2">Líquidos Administrados</legend>

          <div class="mb-2">
            <label for="hora_inicial" class="form-label">Hora Inicial</label>
            <input type="time" id="hora_inicial" name="hora_inicial" class="form-control">
          </div>
          <div class="mb-2">
            <label for="hora_final" class="form-label">Hora Final</label>
            <input type="time" id="hora_final" name="hora_final" class="form-control">
          </div>
          <div class="mb-2">
            <label for="liquido_admin" class="form-label">Líquido</label>
            <input type="text" id="liquido_admin" name="liquido_admin" class="form-control">
          </div>
          <div class="mb-2">
            <label for="via_admin" class="form-label">Vía de administración</label>
            <input type="text" id="via_admin" name="via_admin" class="form-control">
          </div>
          <div class="mb-2">
            <label for="cantidad_admin" class="form-label">Cantidad</label>
            <input type="number" step="any" min="0" id="cantidad_admin"
                   name="cantidad_admin" class="form-control">
          </div>
        </fieldset>
      </div>

      <!-- Eliminados -->
      <div class="col-md-6">
        <fieldset class="border rounded p-3 h-100 mb-3">
          <legend class="w-auto px-2">Líquidos Eliminados</legend>

          <div class="mb-2">
            <label for="hora_eliminado" class="form-label">Hora Eliminado</label>
            <input type="time" id="hora_eliminado" name="hora_eliminado" class="form-control">
          </div>
          <div class="mb-2">
            <label for="tipo_liquido" class="form-label">Tipo Líquido</label>
            <input type="text" id="tipo_liquido" name="tipo_liquido" class="form-control">
          </div>
          <div class="mb-2">
            <label for="via_eliminacion" class="form-label">Vía de eliminación</label>
            <input type="text" id="via_eliminacion" name="via_eliminacion" class="form-control">
          </div>
          <div class="mb-2">
            <label for="cantidad_elim" class="form-label">Cantidad</label>
            <input type="number" step="any" min="0" id="cantidad_elim"
                   name="cantidad_elim" class="form-control">
          </div>
          <div class="mb-2">
            <label for="obs_eliminado" class="form-label">Observaciones</label>
            <textarea id="obs_eliminado" name="obs_eliminado"
                      class="form-control" rows="2"></textarea>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- Observaciones globales -->
    <div class="mb-3">
      <label for="observaciones" class="form-label">Observaciones</label>
      <textarea id="observaciones" name="observaciones" class="form-control" rows="3"></textarea>
    </div>

    <!-- Botón principal de guardar -->
    <div class="mb-4 text-end">
      <button type="submit" class="btn btn-primary">
        Crear Registro
      </button>
    </div>

    <!-- ================= HISTORIAL SIGNOS ================= -->
    <div class="mb-4">
      <div class="card">
        <div class="card-header py-2">
          <strong style="font-size: 0.95rem;">Registros de signos vitales</strong>
        </div>
        <div class="card-body p-2" style="font-size: 0.85rem;">
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Fecha</th>
                  <th>t/a</th>
                  <th>fc</th>
                  <th>fr</th>
                  <th>t°</th>
                  <th>SO2</th>
                  <th>Glicemia</th>
                  <th>Observaciones</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for r in registros %}
                <tr>
                  <td>{{ r.fecha_registro.strftime('%Y-%m-%d %H:%M') if r.fecha_registro else '' }}</td>
                  <td>{{ r.sv.get('ta','') }}</td>
                  <td>{{ r.sv.get('fc','') }}</td>
                  <td>{{ r.sv.get('fr','') }}</td>
                  <td>{{ r.sv.get('temp','') }}</td>
                  <td>{{ r.sv.get('so2','') }}</td>
                  <td>{{ r.control_glicemia or '' }}</td>
                  <td>{{ r.observaciones or '' }}</td>
                  <td class="text-center">
                    <form method="POST"
                          action="{{ url_for('enfermeria.eliminar_registro_enfermeria',
                                             registro_id=r.id) }}"
                          onsubmit="return confirm('¿Eliminar este registro de enfermería completo?');">
                      <button type="submit" class="btn btn-sm btn-danger">
                        <i class="fa fa-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="9" class="text-center">Sin registros previos</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= HISTORIAL LÍQUIDOS ================= -->
    <div class="row mb-4">
      <!-- Administrados -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header py-2">
            <strong style="font-size: 0.9rem;">Líquidos administrados registrados</strong>
          </div>
          <div class="card-body p-2" style="font-size: 0.8rem;">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Hora ini.</th>
                    <th>Hora fin.</th>
                    <th>Líquido</th>
                    <th>Vía</th>
                    <th>Cant.</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% set hay_admin = false %}
                  {% for r in registros %}
                    {% if r.bl_admin.get('hora_inicial') or r.bl_admin.get('hora_final') or
                          r.bl_admin.get('liquido') or r.bl_admin.get('via') or r.bl_admin.get('cantidad') %}
                      {% set hay_admin = true %}
                      <tr>
                        <td>{{ r.fecha_registro.strftime('%Y-%m-%d %H:%M') if r.fecha_registro else '' }}</td>
                        <td>{{ r.bl_admin.get('hora_inicial','') }}</td>
                        <td>{{ r.bl_admin.get('hora_final','') }}</td>
                        <td>{{ r.bl_admin.get('liquido','') }}</td>
                        <td>{{ r.bl_admin.get('via','') }}</td>
                        <td>{{ r.bl_admin.get('cantidad','') }}</td>
                        <td class="text-center">
                          <form method="POST"
                                action="{{ url_for('enfermeria.eliminar_registro_enfermeria',
                                                   registro_id=r.id) }}"
                                onsubmit="return confirm('¿Eliminar este registro de balance (incluye signos vitales si los hay)?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                              <i class="fa fa-trash"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                  {% if not hay_admin %}
                  <tr>
                    <td colspan="7" class="text-center">Sin registros</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Eliminados -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header py-2">
            <strong style="font-size: 0.9rem;">Líquidos eliminados registrados</strong>
          </div>
          <div class="card-body p-2" style="font-size: 0.8rem;">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Tipo</th>
                    <th>Vía</th>
                    <th>Cant.</th>
                    <th>Obs.</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% set hay_elim = false %}
                  {% for r in registros %}
                    {% if r.bl_elim.get('hora_eliminado') or r.bl_elim.get('tipo_liquido') or
                          r.bl_elim.get('via_eliminacion') or r.bl_elim.get('cantidad') or r.bl_elim.get('obs') %}
                      {% set hay_elim = true %}
                      <tr>
                        <td>{{ r.fecha_registro.strftime('%Y-%m-%d %H:%M') if r.fecha_registro else '' }}</td>
                        <td>{{ r.bl_elim.get('hora_eliminado','') }}</td>
                        <td>{{ r.bl_elim.get('tipo_liquido','') }}</td>
                        <td>{{ r.bl_elim.get('via_eliminacion','') }}</td>
                        <td>{{ r.bl_elim.get('cantidad','') }}</td>
                        <td>{{ r.bl_elim.get('obs','') }}</td>
                        <td class="text-center">
                          <form method="POST"
                                action="{{ url_for('enfermeria.eliminar_registro_enfermeria',
                                                   registro_id=r.id) }}"
                                onsubmit="return confirm('¿Eliminar este registro de balance (incluye signos vitales si los hay)?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                              <i class="fa fa-trash"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                  {% if not hay_elim %}
                  <tr>
                    <td colspan="7" class="text-center">Sin registros</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <!-- Resumen de balance -->
            <div class="mt-2 text-center">
              <strong style="color: blue; font-size: 0.9rem;">
                Administrados: {{ total_admin|default(0) }}
                - Eliminados: {{ total_elim|default(0) }}
                = Balance: {{ balance_total|default(0) }}
              </strong>
            </div>
          </div>
        </div>
      </div>
    </div>

  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
