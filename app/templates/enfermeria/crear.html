{% extends "base.html" %}
{% block title %}Añadir registro de enfermería{% endblock %}

{% block content %}
<h2>Registro de enfermería</h2>

<form method="post">
  {{ csrf_token() if csrf_token is defined }}

  <!-- Selección de historia clínica -->
  <div class="mb-3">
    <label for="historia_clinica_id" class="form-label">Historia clínica</label>
    <select name="historia_clinica_id" id="historia_clinica_id"
            class="form-select" required>
      <option value="">Seleccione...</option>
      {% for h in historias %}
        <option value="{{ h.id }}">
          {{ h.numero_ingreso }} - {{ h.fecha_registro.strftime('%Y-%m-%d') }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Turno -->
  <div class="mb-3">
    <label for="turno" class="form-label">Turno de enfermería</label>
    <select name="turno" id="turno" class="form-select">
      {% for t in turnos %}
        <option value="{{ t }}"
                {% if t == turno_actual %}selected{% endif %}>
          {{ t }}
        </option>
      {% endfor %}
    </select>
    <small class="text-muted">
      Turno sugerido actual: {{ turno_actual }}
    </small>
  </div>

  <!-- Signos vitales -->
  <h4>Signos vitales</h4>
  <div class="row">
    <div class="col-md-2 mb-3">
      <label class="form-label">TA</label>
      <input type="text" name="ta" class="form-control">
    </div>
    <div class="col-md-2 mb-3">
      <label class="form-label">FC</label>
      <input type="text" name="fc" class="form-control">
    </div>
    <div class="col-md-2 mb-3">
      <label class="form-label">FR</label>
      <input type="text" name="fr" class="form-control">
    </div>
    <div class="col-md-2 mb-3">
      <label class="form-label">Temp</label>
      <input type="text" name="temp" class="form-control">
    </div>
    <div class="col-md-2 mb-3">
      <label class="form-label">SatO2</label>
      <input type="text" name="so2" class="form-control">
    </div>
    <div class="col-md-2 mb-3">
      <label class="form-label">Glicemia</label>
      <input type="text" name="control_glicemia" class="form-control">
    </div>
  </div>

  <hr>

  <!-- Balance de líquidos -->
  <h4>Balance de líquidos</h4>
  <div class="row">
    <div class="col-md-3 mb-3">
      <label class="form-label">Hora inicial admin.</label>
      <input type="time" name="hora_inicial" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Hora final admin.</label>
      <input type="time" name="hora_final" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Líquido administrado</label>
      <input type="text" name="liquido_admin" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Vía administración</label>
      <input type="text" name="via_admin" class="form-control">
    </div>
  </div>

  <div class="row">
    <div class="col-md-3 mb-3">
      <label class="form-label">Cantidad administrada (ml)</label>
      <input type="number" step="0.01" name="cantidad_admin" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Hora eliminado</label>
      <input type="time" name="hora_eliminado" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Tipo de líquido eliminado</label>
      <input type="text" name="tipo_liquido" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Vía eliminación</label>
      <input type="text" name="via_eliminacion" class="form-control">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Cantidad eliminada (ml)</label>
    <input type="number" step="0.01" name="cantidad_elim" class="form-control">
  </div>

  <div class="mb-3">
    <label class="form-label">Observaciones eliminación</label>
    <textarea name="obs_eliminado" class="form-control" rows="2"></textarea>
  </div>

  <hr>

  <!-- Observaciones generales -->
  <div class="mb-3">
    <label class="form-label">Observaciones generales</label>
    <textarea name="observaciones" class="form-control" rows="3"></textarea>
  </div>

  <button type="submit" class="btn btn-success">Guardar registro</button>
  <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente_id) }}"
     class="btn btn-secondary">
    Cancelar
  </a>
</form>

<hr>

<!-- PREVISUALIZACIÓN DEL TURNO ACTUAL -->
<h3>Registros del turno actual ({{ turno_actual }})</h3>
<p>Fecha: {{ fecha_hoy }}</p>

<!-- Signos vitales del turno -->
<h4>Signos vitales / Glicemia</h4>
<table class="table table-sm table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Hora</th>
      <th>TA</th>
      <th>FC</th>
      <th>FR</th>
      <th>Temp</th>
      <th>SatO2</th>
      <th>Glicemia</th>
      <th>Obs.</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for r in registros %}
      <tr>
        <td>{{ r.fecha_registro.strftime('%Y-%m-%d') if r.fecha_registro else '' }}</td>
        <td>{{ r.fecha_registro.strftime('%H:%M') if r.fecha_registro else '' }}</td>
        <td>{{ r.sv.ta or '' }}</td>
        <td>{{ r.sv.fc or '' }}</td>
        <td>{{ r.sv.fr or '' }}</td>
        <td>{{ r.sv.temp or '' }}</td>
        <td>{{ r.sv.so2 or '' }}</td>
        <td>{{ r.control_glicemia or '' }}</td>
        <td>{{ r.observaciones or '' }}</td>
        <td>
          <form method="post"
                action="{{ url_for('enfermeria.eliminar_registro_enfermeria',
                                   registro_id=r.id) }}"
                onsubmit="return confirm('¿Eliminar este registro?');">
            {{ csrf_token() if csrf_token is defined }}
            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="10" class="text-center">
          No hay registros en este turno.
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Balance de líquidos del turno -->
<h4>Balance de líquidos del turno</h4>
<table class="table table-sm table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Hora</th>
      <th>Administrados</th>
      <th>Eliminados</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% set hay_balance = false %}
    {% for r in registros %}
      {% set cant_admin = r.bl_admin.cantidad %}
      {% set cant_elim = r.bl_elim.cantidad %}
      {% if cant_admin or cant_elim %}
        {% set hay_balance = true %}
        <tr>
          <td>{{ r.fecha_registro.strftime('%Y-%m-%d') if r.fecha_registro else '' }}</td>
          <td>{{ r.fecha_registro.strftime('%H:%M') if r.fecha_registro else '' }}</td>
          <td>
            {{ r.bl_admin.cantidad or '' }} ml
            {{ r.bl_admin.liquido or '' }}
            {{ r.bl_admin.via or '' }}
          </td>
          <td>
            {{ r.bl_elim.cantidad or '' }} ml
            {{ r.bl_elim.tipo_liquido or '' }}
            {{ r.bl_elim.via_eliminacion or '' }}
          </td>
          <td>
            <form method="post"
                  action="{{ url_for('enfermeria.eliminar_registro_enfermeria',
                                     registro_id=r.id) }}"
                  onsubmit="return confirm('¿Eliminar este registro de balance?');">
              {{ csrf_token() if csrf_token is defined }}
              <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
            </form>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
    {% if not hay_balance %}
      <tr>
        <td colspan="5" class="text-center">
          No hay balances registrados en este turno.
        </td>
      </tr>
    {% endif %}
  </tbody>
</table>

<p><strong>Balance total del turno:</strong> {{ balance_total }} ml</p>

{% endblock %}
