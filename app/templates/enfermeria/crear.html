{% extends "base.html" %}
{% block title %}Registro Enfermer√≠a - Software SM{% endblock %}

{% block head %}
<style>
    :root {
      --sm-bg-principal: #ffffff;
      --sm-card-bg: #f0e7d8; 
      --sm-titles-btns: #236e7b; 
      --sm-text-links: #0b6169;
      --sm-secondary-text: #5f5f5f;
    }

    body { 
        background-color: var(--sm-bg-principal) !important; 
        color: var(--sm-text-links); 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* OCULTAR FOOTER DE LA BASE SIN ROMPER NADA */
    footer, body > footer, .navbar + footer {
        display: none !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        visibility: hidden !important;
    }

    .header-container-sm {
        background: #ffffff;
        border-top: 5px solid var(--sm-titles-btns);
        border-bottom: 1px solid #e0e0e0;
        padding: 15px 0;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1150px;
        margin: 0 auto;
        padding: 0 15px;
    }
    .brand-section { border-left: 3px solid var(--sm-titles-btns); padding-left: 15px; }
    .brand-title { font-size: 1.4rem; font-weight: 900; color: var(--sm-titles-btns); margin: 0; line-height: 1; }
    
    .info-section-sm { text-align: right; }
    .info-pill { 
        background: var(--sm-card-bg); 
        color: var(--sm-titles-btns); 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-weight: 800; 
        font-size: 0.8rem; 
        display: inline-block;
    }

    .btn-back-sm {
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        color: var(--sm-text-links);
        font-weight: 700;
        font-size: 0.8rem;
        margin: 10px 0 20px 0;
        text-transform: uppercase;
    }

    .ficha-paciente { background-color: var(--sm-card-bg); padding: 18px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .label-ficha { font-size: 0.7rem; color: var(--sm-secondary-text); font-weight: bold; text-transform: uppercase; }
    .dato-ficha { font-size: 1rem; color: #333; font-weight: bold; }
    .panel-sm { background-color: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
    .panel-header { background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #ddd; color: var(--sm-titles-btns); font-weight: bold; text-transform: uppercase; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
    .panel-body { padding: 15px; }
    
    .table-registro-pro { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; border: 1px solid #eee; }
    .table-registro-pro th { background-color: white; color: var(--sm-titles-btns); font-size: 0.75rem; padding: 12px; border-bottom: 2px solid var(--sm-titles-btns); text-transform: uppercase; text-align: center; }
    .table-registro-pro td { padding: 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; font-size: 0.85rem; }
    
    .btn-save-sm { background-color: var(--sm-titles-btns); color: white; border: none; padding: 5px 15px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; cursor: pointer; }
    .form-control-sm { border: 1px solid #ccc; border-radius: 3px; padding: 4px 8px; width: 100%; }

    .footer-ajustado-final {
        text-align: center;
        width: 100%;
        padding: 30px 0;
        color: var(--sm-secondary-text);
        font-size: 0.85rem;
        font-weight: bold;
        text-transform: uppercase;
        border-top: 1px solid #eee;
        margin-top: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="header-container-sm">
    <div class="header-flex">
        <div class="brand-section">
            <h1 class="brand-title">ENFERMER√çA</h1>
        </div>
        <div class="info-section-sm">
            <div class="mb-1"><span class="info-pill">TURNO: {{ turno_actual }}</span></div>
        </div>
    </div>
</div>

<div class="container">
    <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente_id) }}" class="btn-back-sm">‚Üê Volver al Men√∫ del Paciente</a>

    {% set h = historias[0] if historias else None %}
    <div class="ficha-paciente">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="label-ficha">Paciente</div>
                <div class="dato-ficha" style="color: var(--sm-titles-btns);">{{ h.paciente.nombre if h else 'S.N.' }}</div>
            </div>
            <div class="col-md-2">
                <div class="label-ficha">ID</div>
                <div class="dato-ficha">{{ h.paciente.numero if h else '-' }}</div>
            </div>
            <div class="col-md-2">
                <div class="label-ficha">Ingreso</div>
                <div class="dato-ficha"># {{ h.numero_ingreso if h else '-' }}</div>
            </div>
            <div class="col-md-4 text-end">
                <div class="label-ficha">Ubicaci√≥n</div>
                <div class="dato-ficha">CAMA: {{ h.paciente.cama if h else '-' }}</div>
            </div>
        </div>
    </div>

    <form method="POST">
        <input type="hidden" name="historia_clinica_id" value="{{ h.id if h else '' }}">
        <input type="hidden" name="turno" value="{{ turno_actual }}">

        <div class="row">
            <div class="col-12">
                <div class="panel-sm">
                    <div class="panel-header">
                        Registro de Signos Vitales
                        <button type="submit" class="btn-save-sm">GUARDAR SIGNOS</button>
                    </div>
                    <div class="panel-body">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <label class="label-ficha">Hora Registro</label>
                                <input type="time" name="hora_sv" class="form-control-sm" required>
                            </div>
                            <div class="col-md-2"><label class="label-ficha">T.A.</label><input type="text" name="ta" class="form-control-sm"></div>
                            <div class="col-md-1"><label class="label-ficha">F.C.</label><input type="text" name="fc" class="form-control-sm"></div>
                            <div class="col-md-1"><label class="label-ficha">F.R.</label><input type="text" name="fr" class="form-control-sm"></div>
                            <div class="col-md-1"><label class="label-ficha">T¬∞</label><input type="text" name="temp" class="form-control-sm"></div>
                            <div class="col-md-2"><label class="label-ficha">SO2</label><input type="text" name="so2" class="form-control-sm"></div>
                            <div class="col-md-3"><label class="label-ficha">Glicemia</label><input type="text" name="control_glicemia" class="form-control-sm"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="panel-sm">
                    <div class="panel-header">
                        Administrados
                        <button type="submit" class="btn-save-sm">GUARDAR INGRESO</button>
                    </div>
                    <div class="panel-body">
                        <div class="row g-2">
                            <div class="col-6"><label class="label-ficha">Hora</label><input type="time" name="hora_inicial" class="form-control-sm"></div>
                            <div class="col-6"><label class="label-ficha">Cant (ml)</label><input type="number" name="cantidad_admin" class="form-control-sm"></div>
                            <div class="col-12 mt-2"><label class="label-ficha">L√≠quido</label><input type="text" name="liquido_admin" class="form-control-sm" list="list_ingresos"></div>
                            <div class="col-12 mt-2"><label class="label-ficha">V√≠a</label><input type="text" name="via_admin" class="form-control-sm" list="list_vias_admin"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="panel-sm">
                    <div class="panel-header">
                        Eliminados
                        <button type="submit" class="btn-save-sm">GUARDAR EGRESO</button>
                    </div>
                    <div class="panel-body">
                        <div class="row g-2">
                            <div class="col-6"><label class="label-ficha">Hora</label><input type="time" name="hora_eliminado" class="form-control-sm"></div>
                            <div class="col-6"><label class="label-ficha">Cant (ml)</label><input type="number" name="cantidad_elim" class="form-control-sm"></div>
                            <div class="col-12 mt-2"><label class="label-ficha">Tipo</label><input type="text" name="tipo_liquido" class="form-control-sm" list="list_egresos"></div>
                            <div class="col-12 mt-2"><label class="label-ficha">V√≠a Elim</label><input type="text" name="via_eliminacion" class="form-control-sm" list="list_vias_elim"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <h5 class="mt-4 fw-bold" style="color: var(--sm-titles-btns);">HISTORIAL DEL TURNO</h5>
    
    <table class="table-registro-pro">
        <thead>
            <tr><th>Hora</th><th>T.A.</th><th>F.C.</th><th>F.R.</th><th>T¬∞</th><th>SO2</th><th>Glicemia</th></tr>
        </thead>
        <tbody class="text-center">
            {% for r in registros|sort(attribute='fecha_registro') %}
                {% if r.sv.ta or r.sv.fc or r.control_glicemia %}
                <tr>
                    <td class="fw-bold">{{ r.fecha_registro.strftime('%H:%M') }}</td>
                    <td>{{ r.sv.ta or '-' }}</td><td>{{ r.sv.fc or '-' }}</td><td>{{ r.sv.fr or '-' }}</td>
                    <td>{{ r.sv.temp or '-' }}</td><td>{{ r.sv.so2 or '-' }}</td><td>{{ r.control_glicemia or '-' }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="row mt-3">
        <div class="col-md-6">
            <h6 class="fw-bold text-primary small">üíß INGRESOS (Administrados)</h6>
            <table class="table-registro-pro">
                <thead>
                    <tr><th width="30%">Hora</th><th>L√≠quido</th><th width="30%">ml</th></tr>
                </thead>
                <tbody>
                    {% set ns_adm = namespace(found=false) %}
                    {% for r in registros|sort(attribute='fecha_registro') %}
                        {% if r.bl_admin.cantidad and r.bl_admin.cantidad|float > 0 %}
                            {% set ns_adm.found = true %}
                            <tr>
                                <td class="text-center fw-bold">{{ r.fecha_registro.strftime('%H:%M') }}</td>
                                <td>{{ r.bl_admin.liquido }} <br><small class="text-muted">{{ r.bl_admin.via }}</small></td>
                                <td class="text-end fw-bold text-primary">+{{ r.bl_admin.cantidad }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                    {% if not ns_adm.found %}
                        <tr><td colspan="3" class="text-center text-muted py-3">No hay ingresos</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h6 class="fw-bold text-danger small">üöΩ EGRESOS (Eliminados)</h6>
            <table class="table-registro-pro">
                <thead>
                    <tr><th width="30%">Hora</th><th>Tipo</th><th width="30%">ml</th></tr>
                </thead>
                <tbody>
                    {% set ns_eli = namespace(found=false) %}
                    {% for r in registros|sort(attribute='fecha_registro') %}
                        {% if r.bl_elim.cantidad and r.bl_elim.cantidad|float > 0 %}
                            {% set ns_eli.found = true %}
                            <tr>
                                <td class="text-center fw-bold">{{ r.fecha_registro.strftime('%H:%M') }}</td>
                                <td>{{ r.bl_elim.tipo_liquido }} <br><small class="text-muted">{{ r.bl_elim.via_eliminacion }}</small></td>
                                <td class="text-end fw-bold text-danger">-{{ r.bl_elim.cantidad }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                    {% if not ns_eli.found %}
                        <tr><td colspan="3" class="text-center text-muted py-3">No hay egresos</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3 p-3 text-end" style="background: var(--sm-card-bg); border-radius: 8px;">
        <span class="me-4">Total Ingresos: <strong class="text-primary">+{{ total_admin }} ml</strong></span>
        <span class="me-4">Total Egresos: <strong class="text-danger">-{{ total_elim }} ml</strong></span>
        <span>Balance Turno: <strong style="color: var(--sm-titles-btns); font-size: 1.1rem;">{{ balance_total }} ml</strong></span>
    </div>

    <div class="footer-ajustado-final">
        &copy; 2026 Software SM - CENCATECH
    </div>
</div>

<datalist id="list_ingresos">
    <option value="AGUA MAS MTO"><option value="ALMUERZO"><option value="AROIMATICA CON GALLRTICAS"><option value="CENA"><option value="COLADA"><option value="COMIDA"><option value="DESAYUNO"><option value="DIETA"><option value="MEDICAMENTO"><option value="MEDICAMENTO + AGUA"><option value="MEDICAMENTO + SSN0.9%"><option value="SSN"><option value="SSN MAS MTO">
</datalist>
<datalist id="list_vias_admin">
    <option value="Oral"><option value="Oral Sonda"><option value="Oral Succion"><option value="Endovenosa"><option value="Intramuscular"><option value="Subcutaneo"><option value="T√≥pico"><option value="Infusi√≥n"><option value="Nutricion Enteral"><option value="Nutricion Parenteral"><option value="Inhalatoria">
</datalist>
<datalist id="list_egresos">
    <option value="ORINA"><option value="EMESIS"><option value="MATERIA FECAL"><option value="SANGRE"><option value="BILIAR"><option value="LIQUIDO PLEURAL"><option value="OTRO">
</datalist>
<datalist id="list_vias_elim">
    <option value="Sonda Vesical"><option value="Diarrea"><option value="Emesis"><option value="Sonda Gastrica"><option value="Dren Penrose"><option value="Hemovac"><option value="Otros Drenes"><option value="Tubo en T"><option value="Tubo a Torax"><option value="Ventriculostomia"><option value="Bolsa Recolectora"><option value="Irrigacion Vesical"><option value="Espontaneo">
</datalist>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function establecerLimitesHora() {
            const ahora = new Date();
            const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + ahora.getMinutes().toString().padStart(2, '0');
            const inputsHora = document.querySelectorAll('input[type="time"]');
            inputsHora.forEach(input => {
                input.max = horaActual; 
                if (!input.value) {
                    input.value = horaActual;
                }
            });
        }
        establecerLimitesHora();

        document.querySelector('form').addEventListener('submit', function(e) {
            const ahora = new Date();
            const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + ahora.getMinutes().toString().padStart(2, '0');
            const inputsHora = document.querySelectorAll('input[type="time"]');
            let esValido = true;
            inputsHora.forEach(input => {
                if (input.value && input.value > horaActual) {
                    alert('No se permiten registros con horas futuras.');
                    esValido = false;
                }
            });
            if (!esValido) e.preventDefault();
        });
    });
</script>
{% endblock %}