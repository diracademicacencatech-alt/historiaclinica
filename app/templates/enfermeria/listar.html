<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pacientes con Historia Clínica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
</head>
<body>
<div class="row mb-4">
  <div class="col-md-6">
    <input type="text" id="buscador_paciente" class="form-control" placeholder="Buscar por documento, nombre o ingreso">
  </div>
  <div class="col-md-2">
    <button class="btn btn-outline-secondary" onclick="buscarYCompletarPaciente()">Buscar</button>
  </div>
</div>
<table class="table table-bordered table-striped" id="tabla_pacientes">
  <thead>
    <tr>
      <th>ID</th>
      <th>Paciente</th>
      <th>Acciones</th>
      <th>Visualización</th>
    </tr>
  </thead>
  <tbody id="pacientes_tbody">
    {% for paciente in pacientes %}
    <tr>
      <td>{{ paciente.id }}</td>
      <td>{{ paciente.nombre }}</td>
      <td>
        <a class="btn btn-sm btn-primary mb-1" href="{{ url_for('enfermeria.crear', paciente_id=paciente.id) }}">+ Añadir registro de enfermería</a>
        <a class="btn btn-sm btn-info mb-1" href="{{ url_for('enfermeria.detalle', paciente_id=paciente.id) }}">Ver registros</a>
        <a class="btn btn-sm btn-warning mb-1" href="{{ url_for('enfermeria.crear_nota', paciente_id=paciente.id) }}">Crear notas de enfermería</a>
      </td>
      <td>
        <a class="btn btn-sm btn-secondary" href="{{ url_for('enfermeria.exportar_pdf', paciente_id=paciente.id) }}" target="_blank">
          <i class="fas fa-file-pdf"></i> Visualizar PDF
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
<script>
function buscarYCompletarPaciente() {
  var query = document.getElementById('buscador_paciente').value.trim();
  if (!query) {
    location.reload(); // Si vacío, recarga para mostrar todos
    return;
  }
  fetch('/enfermeria/api/buscar_info_paciente?q=' + encodeURIComponent(query))
    .then(r => r.json())
    .then(data => {
      let tbody = document.getElementById('pacientes_tbody');
      tbody.innerHTML = "";
      if (data.error) {
        tbody.innerHTML = '<tr><td colspan="4">No encontrado</td></tr>';
        return;
      }
      let fila = `
        <tr class="table-primary">
          <td>${data.paciente_id}</td>
          <td>${data.nombre}</td>
          <td>
            <a class="btn btn-sm btn-primary" href="/enfermeria/crear?paciente_id=${data.paciente_id}">+ Añadir registro de enfermería</a>
            <a class="btn btn-sm btn-info" href="/enfermeria/detalle/${data.paciente_id}">Ver registros</a>
            <a class="btn btn-sm btn-warning" href="/enfermeria/nota/crear?paciente_id=${data.paciente_id}">Crear notas de enfermería</a>
          </td>
          <td>
            <a class="btn btn-sm btn-secondary" href="/enfermeria/pdf/${data.paciente_id}" target="_blank">
              <i class="fas fa-file-pdf"></i> Visualizar PDF
            </a>
          </td>
        </tr>
      `;
      tbody.innerHTML = fila;
    });
}
</script>
</body>
</html>
