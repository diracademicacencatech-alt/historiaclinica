{% extends "base.html" %}
{% block title %}Solicitar Insumos - {{ paciente.nombre }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üß¥ Solicitar Insumos - {{ paciente.nombrecompleto }}</h2>

    <!-- FORMULARIO PARA SOLICITAR INSUMO -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-plus-square me-2"></i>Nuevo insumo</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('enfermeria.solicitar_insumos', paciente_id=paciente.id) }}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Insumo disponible</label>
                        <select name="insumo_id" class="form-select" required>
                            <option value="">-- Seleccione --</option>
                            {% for insumo in insumos_json %}
                            <option value="{{ insumo.id }}">
                                {{ insumo.nombre }} (Stock: {{ insumo.stock_actual }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-bold">Cantidad</label>
                        <input type="number" name="cantidad" class="form-control" min="1" value="1" required>
                    </div>
                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-save me-1"></i> Solicitar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ TABLA AGRUPADA + ACCIONES INDIVIDUALES -->
    {% if insumos_solicitados %}
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìã Insumos Solicitados Agrupados ({{ insumos_solicitados|length }})</h5>

            <!-- Bot√≥n LIMPIAR TODOS PENDIENTES -->
            <form method="POST"
                  action="{{ url_for('enfermeria.limpiar_insumos_solicitados', paciente_id=paciente.id) }}"
                  class="d-inline"
                  onsubmit="return confirm('üóëÔ∏è Eliminar TODOS los insumos pendientes de este paciente?');">
                <button type="submit" class="btn btn-warning btn-sm">
                    <i class="fas fa-broom"></i> Limpiar pendientes
                </button>
            </form>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Insumo</th>
                            <th>Solic. total</th>
                            <th>Usado</th>
                            <th style="width:80px;">Pendiente</th>
                            <th style="width:90px;">√öltimo ID</th>
                            <th style="width:70px;">Solic.</th>
                            <th style="width:130px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ins in insumos_solicitados %}
                        <tr class="{% if ins.pendiente > 0 %}table-warning{% else %}table-success{% endif %}">
                            <td><strong>{{ ins.nombre }}</strong></td>
                            <td>{{ "%.1f"|format(ins.total_solicitado) }}</td>
                            <td>{{ "%.1f"|format(ins.total_usado) }}</td>
                            <td class="fw-bold {% if ins.pendiente > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(ins.pendiente) }}
                            </td>
                            <td><code>{{ ins.ultimo_id }}</code></td>
                            <td><span class="badge bg-secondary">{{ ins.num_solicitudes }}</span></td>
                            <td>
                                <!-- üóëÔ∏è Eliminar SOLO la √∫ltima solicitud (usa insumo_paciente_id real) -->
                                <form method="POST"
                                      action="{{ url_for('enfermeria.eliminar_insumo_individual',
                                                        paciente_id=paciente.id,
                                                        insumo_paciente_id=ins.ultimo_id) }}"
                                      class="d-inline me-1"
                                      onsubmit="return confirm('üóëÔ∏è Eliminar la √∫ltima solicitud de {{ ins.nombre }} (ID {{ ins.ultimo_id }})?');">
                                    <button type="submit" class="btn btn-danger btn-sm p-1" title="Eliminar √∫ltima">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>

                                <!-- ‚úÖ Ir a registrar uso (solo si hay pendiente) -->
                                {% if ins.pendiente > 0 %}
                                <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}"
                                   class="btn btn-success btn-sm p-1" title="Registrar uso">
                                    <i class="fas fa-check"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bot√≥n registrar masivo (lleva a la pantalla de registrar_insumos) -->
        <div class="card-footer bg-light">
            {% set pend_list = insumos_solicitados|selectattr('pendiente', '>', 0)|list %}
            {% if pend_list %}
            <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}"
               class="btn btn-success btn-lg w-100">
                <i class="fas fa-syringe me-2"></i>
                Registrar uso de {{ pend_list|length }} insumos con pendientes
            </a>
            {% endif %}
        </div>
        <form method="POST"
      action="{{ url_for('enfermeria.reset_insumos_paciente', paciente_id=paciente.id) }}"
      class="d-inline"
      onsubmit="return confirm('‚ö†Ô∏è HARD RESET: eliminar TODAS las solicitudes de insumos (incluye usadas). ¬øContinuar?');">
    <button type="submit" class="btn btn-danger btn-sm">
        <i class="fas fa-trash-alt"></i> Reset total
    </button>
</form>

    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
        <h5>‚úÖ Sin insumos pendientes</h5>
        <p class="mb-0">¬°Tabla limpia! Solicita nuevos insumos en el formulario superior.</p>
    </div>
    {% endif %}

    <!-- Volver -->
    <div class="mt-4">
        <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" class="btn btn-secondary">
            ‚Üê Volver al men√∫
        </a>
    </div>
</div>

<style>
.table th { font-size: 0.85rem; }
.table td { font-size: 0.8rem; vertical-align: middle; }
.btn-sm { font-size: 0.7rem; }
.table-warning { border-left: 4px solid #ffc107; }
</style>
{% endblock %}
