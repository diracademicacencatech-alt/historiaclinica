{% extends "base.html" %}

{% block title %}Solicitar Insumos - {{ paciente.nombre }}{% endblock %}

{% block head %}
<style>
    :root {
      --titles: #236e7b;
      --text-links: #0b6169;
      --text-secondary: #5f5f5f;
      --bg-containers: #f0e7d8;
    }

    .titulo-principal { 
      color: var(--titles); 
      font-weight: 800;
      text-transform: uppercase;
    }

    /* CARD DE SOLICITUD */
    .card-solicitud {
        background-color: #ffffff;
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border-top: 5px solid var(--titles);
    }

    .card-solicitud .card-header {
        background-color: var(--bg-containers);
        color: var(--titles);
        font-weight: 700;
        border: none;
    }

    /* TABLA DE GESTIÃ“N */
    .table-insumos thead {
        background-color: var(--titles);
        color: white;
        text-transform: uppercase;
        font-size: 0.75rem;
    }

    .table-insumos td {
        vertical-align: middle;
        font-size: 0.85rem;
        padding: 12px 8px;
    }

    /* ESTADOS DE FILA */
    .row-pendiente { border-left: 5px solid #ffc107; background-color: #fffdf5; }
    .row-completo { border-left: 5px solid #28a745; background-color: #f8fff9; }

    /* BOTONES PERSONALIZADOS */
    .btn-verde-sm {
        background-color: var(--titles) !important;
        color: white !important;
        border: none;
        font-weight: 700;
        text-transform: uppercase;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .btn-verde-sm:hover {
        background-color: var(--text-links) !important;
        transform: translateY(-1px);
    }

    .btn-outline-custom {
        border: 2px solid var(--titles);
        color: var(--titles);
        font-weight: 700;
        border-radius: 10px;
    }

    .badge-id {
        background-color: #e9ecef;
        color: #495057;
        font-family: monospace;
        padding: 3px 6px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-2">
    
    <h2 class="titulo-principal mb-4">ðŸ§´ GestiÃ³n de Insumos</h2>

    <div class="alert shadow-sm border-0 mb-4 d-flex align-items-center" style="background-color: var(--bg-containers); color: var(--titles); border-radius: 12px;">
        <i class="fas fa-user-circle fa-2x me-3"></i>
        <div>
            <h6 class="mb-0 fw-bold">{{ paciente.nombrecompleto }}</h6>
            <small class="opacity-75">Solicitud y control de stock por paciente</small>
        </div>
    </div>

    <div class="card card-solicitud mb-5">
        <div class="card-header p-3">
            <i class="fas fa-cart-plus me-2"></i>Nueva Solicitud de Material
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('enfermeria.solicitar_insumos', paciente_id=paciente.id) }}">
                <div class="row g-3">
                    <div class="col-md-7">
                        <label class="form-label fw-bold small text-uppercase">Insumo / Stock Central</label>
                        <select name="insumo_id" class="form-select shadow-sm" style="border-radius: 10px;" required>
                            <option value="">-- Seleccione el insumo --</option>
                            {% for insumo in insumos_json %}
                            <option value="{{ insumo.id }}">
                                {{ insumo.nombre }} (Disponible: {{ insumo.stock_actual }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-uppercase">Cantidad</label>
                        <input type="number" name="cantidad" class="form-control shadow-sm" style="border-radius: 10px;" min="1" value="1" required>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn-verde-sm w-100 p-2 shadow-sm">
                            <i class="fas fa-plus-circle me-1"></i> AÃ±adir a la Lista
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if insumos_solicitados %}
    <div class="d-flex justify-content-between align-items-end mb-2">
        <h5 class="fw-bold" style="color: var(--titles);">ðŸ“‹ Resumen de Insumos Solicitados</h5>
        <form method="POST" action="{{ url_for('enfermeria.limpiar_insumos_solicitados', paciente_id=paciente.id) }}" 
              onsubmit="return confirm('ðŸ—‘ï¸ Â¿Desea eliminar TODOS los insumos pendientes?');">
            <button type="submit" class="btn btn-sm btn-link text-danger text-decoration-none fw-bold">
                <i class="fas fa-broom me-1"></i> Limpiar Pendientes
            </button>
        </form>
    </div>

    <div class="card shadow-sm border-0 overflow-hidden" style="border-radius: 15px;">
        <div class="table-responsive">
            <table class="table table-hover table-insumos mb-0">
                <thead>
                    <tr>
                        <th class="ps-3">Insumo</th>
                        <th class="text-center">Solicitado</th>
                        <th class="text-center">Usado</th>
                        <th class="text-center">Pendiente</th>
                        <th class="text-center">Solicitudes</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ins in insumos_solicitados %}
                    <tr class="{% if ins.pendiente > 0 %}row-pendiente{% else %}row-completo{% endif %}">
                        <td class="ps-3">
                            <strong style="color: var(--text-links);">{{ ins.nombre }}</strong><br>
                            <small class="text-muted">Ãšltimo ID: </small><span class="badge-id">{{ ins.ultimo_id }}</span>
                        </td>
                        <td class="text-center fw-bold">{{ "%.0f"|format(ins.total_solicitado) }}</td>
                        <td class="text-center text-muted">{{ "%.0f"|format(ins.total_usado) }}</td>
                        <td class="text-center">
                            <span class="badge {% if ins.pendiente > 0 %}bg-danger{% else %}bg-success{% endif %}" style="font-size: 0.9rem;">
                                {{ "%.0f"|format(ins.pendiente) }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge rounded-pill bg-secondary px-3">{{ ins.num_solicitudes }} vez/veces</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group shadow-sm">
                                <form method="POST" action="{{ url_for('enfermeria.eliminar_insumo_individual', paciente_id=paciente.id, insumo_paciente_id=ins.ultimo_id) }}" 
                                      onsubmit="return confirm('Â¿Eliminar la Ãºltima solicitud de {{ ins.nombre }}?');">
                                    <button type="submit" class="btn btn-white btn-sm text-danger border" title="Eliminar Ãºltima">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                                {% if ins.pendiente > 0 %}
                                <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}" 
                                   class="btn btn-white btn-sm text-success border" title="Ir a registrar">
                                    <i class="fas fa-check-double"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% set pend_list = insumos_solicitados|selectattr('pendiente', '>', 0)|list %}
        {% if pend_list %}
        <div class="card-footer p-3 text-center bg-white border-top">
            <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}" 
               class="btn-verde-sm d-inline-block px-5 shadow">
                <i class="fas fa-syringe me-2"></i> REGISTRAR USO DE MATERIALES
            </a>
        </div>
        {% endif %}
    </div>

    <div class="mt-3 text-end">
        <form method="POST" action="{{ url_for('enfermeria.reset_insumos_paciente', paciente_id=paciente.id) }}" 
              onsubmit="return confirm('âš ï¸ ADVERTENCIA: Se eliminarÃ¡ TODO el historial de insumos de este paciente. Â¿Continuar?');">
            <button type="submit" class="btn btn-sm text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-exclamation-triangle me-1"></i> Hard Reset (Limpiar Historial Completo)
            </button>
        </form>
    </div>

    {% else %}
    <div class="text-center py-5 bg-white shadow-sm" style="border-radius: 15px;">
        <i class="fas fa-clipboard-check fa-4x mb-3" style="color: #d4edda;"></i>
        <h5 class="text-muted">No hay insumos solicitados para este paciente.</h5>
        <p class="small text-secondary">Use el formulario superior para aÃ±adir materiales al plan de cuidado.</p>
    </div>
    {% endif %}

    <div class="mt-5">
        <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" class="btn btn-outline-custom px-4">
            <i class="fas fa-chevron-left me-2"></i> VOLVER AL MENÃš
        </a>
    </div>
</div>
{% endblock %}