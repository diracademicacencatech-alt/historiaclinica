{% extends "base.html" %}

{% block title %}Folio Clínico Completo - {{ paciente.nombre }}{% endblock %}

{% block head %}
<style>
    :root {
      --bg-containers: #f0e7d8;
      --titles: #236e7b;
      --primary-text: #0b6169;
      --btn-green: #28a745; 
      --btn-red: #dc3545; /* Nuevo color para eliminar */
      --secondary-text: #5f5f5f;
    }

    body { 
        background-color: white !important; 
        font-family: 'Courier New', Courier, monospace;
        font-size: 13px;
        color: var(--primary-text);
    }

    .hoja-folio {
        background-color: white;
        width: 215mm;
        min-height: 279mm;
        margin: 20px auto;
        padding: 15mm;
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }

    .seccion-negra {
        background-color: #000;
        color: #fff;
        font-weight: bold;
        text-align: center;
        padding: 5px;
        text-transform: uppercase;
        margin-top: 15px;
        margin-bottom: 5px;
    }

    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
    th, td { border: 1px solid #000; padding: 4px; text-align: left; word-wrap: break-word; }
    th { background-color: var(--bg-containers); color: var(--titles); font-size: 9px; }
    
    .btn-verde-folio {
        background-color: var(--btn-green);
        color: white !important;
        padding: 2px 6px;
        border-radius: 3px;
        text-decoration: none;
        font-size: 13px;
        border: none;
        display: inline-block;
    }

    /* Estilo para el botón X */
    .btn-rojo-folio {
        background-color: var(--btn-red);
        color: white !important;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 13px;
        border: none;
        display: inline-block;
        cursor: pointer;
    }

    .text-bloqueado { color: var(--secondary-text); font-size: 13px; font-style: italic; }

    @media print {
        .no-print { display: none !important; }
        .hoja-folio { box-shadow: none; margin: 0; width: 100%; padding: 10mm; }
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print" style="text-align:center; margin-bottom: 20px;">
    <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" class="btn btn-secondary btn-sm">VOLVER AL MENÚ</a>
    <button onclick="window.print()" class="btn btn-dark btn-sm">IMPRIMIR FOLIO PDF</button>
</div>

<div class="hoja-folio">
    <div style="text-align:center; border: 2px solid #000; padding: 10px;">
        <h2 style="margin:0; color: var(--titles);">REGISTRO CLÍNICO ENFERMERÍA</h2>
        <p style="margin:5px 0;"><strong>{{ paciente.nombre }}</strong> | Doc: {{ paciente.numero }} | Cama: {{ paciente.cama or 'S/A' }}</p>
    </div>

    <div class="seccion-negra">Control de Signos Vitales</div>
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">FECHA/HORA</th>
                <th>T.A</th><th>F.C</th><th>F.R</th><th>TEMP</th><th>SatO2</th><th>GLIC.</th>
                <th class="no-print" style="width: 15%;">ACCIÓN</th>
            </tr>
        </thead>
        <tbody>
            {% for r in registros %}
                {% if r.signos_vitales_dict.ta or r.signos_vitales_dict.fc or r.control_glicemia %}
                <tr>
                    <td>{{ r.fecha_registro.strftime('%d/%m %H:%M') }}</td>
                    <td>{{ r.signos_vitales_dict.ta or '-' }}</td>
                    <td>{{ r.signos_vitales_dict.fc or '-' }}</td>
                    <td>{{ r.signos_vitales_dict.fr or '-' }}</td>
                    <td>{{ r.signos_vitales_dict.temp or '-' }}</td>
                    <td>{{ r.signos_vitales_dict.so2 or '-' }}</td>
                    <td>{{ r.control_glicemia or '-' }}</td>
                    <td class="no-print">
                        {% if puede_editar_turno_template(r) %}
                            <a href="{{ url_for('enfermeria.editar_signos', registro_id=r.id) }}" class="btn-verde-folio">Editar</a>
                            <form action="{{ url_for('enfermeria.eliminar_signos_enfermeria', registro_id=r.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Eliminar signos?')">
                                <button type="submit" class="btn-rojo-folio">X</button>
                            </form>
                        {% else %}<span class="text-bloqueado">Bloqueado</span>{% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="seccion-negra">Líquidos Administrados</div>
    <table>
        <thead>
            <tr><th style="width: 15%;">FECHA/HORA</th><th>LÍQUIDO / CANTIDAD</th><th class="no-print" style="width: 15%;">ACCIÓN</th></tr>
        </thead>
        <tbody>
            {% for r in registros if r.balance_liquidos_dict.get('administrados', {}).get('cantidad') %}
                <tr>
                    <td>{{ r.fecha_registro.strftime('%d/%m %H:%M') }}</td>
                    <td>{{ r.balance_liquidos_dict.administrados.liquido }}: {{ r.balance_liquidos_dict.administrados.cantidad }}cc</td>
                    <td class="no-print">
                        {% if puede_editar_turno_template(r) %}
                            <a href="{{ url_for('enfermeria.editar_balance', registro_id=r.id) }}" class="btn-verde-folio">Editar</a>
                        {% else %}<span class="text-bloqueado">Bloqueado</span>{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="seccion-negra">Líquidos Eliminados</div>
    <table>
        <thead>
            <tr><th style="width: 15%;">FECHA/HORA</th><th>TIPO / CANTIDAD</th><th class="no-print" style="width: 15%;">ACCIÓN</th></tr>
        </thead>
        <tbody>
            {% for r in registros if r.balance_liquidos_dict.get('eliminados', {}).get('cantidad') %}
                <tr>
                    <td>{{ r.fecha_registro.strftime('%d/%m %H:%M') }}</td>
                    <td>{{ r.balance_liquidos_dict.eliminados.tipo_liquido }}: {{ r.balance_liquidos_dict.eliminados.cantidad }}cc</td>
                    <td class="no-print">
                        {% if puede_editar_turno_template(r) %}
                            <a href="{{ url_for('enfermeria.editar_balance', registro_id=r.id) }}" class="btn-verde-folio">Editar</a>
                        {% else %}<span class="text-bloqueado">Bloqueado</span>{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="seccion-negra">Administración de Medicamentos</div>
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">FECHA/HORA</th>
                <th>MEDICAMENTO</th>
                <th>CANTIDAD</th>
                <th class="no-print" style="width: 15%;">ACCIÓN</th>
            </tr>
        </thead>
        <tbody>
            {% for m in medicamentos %}
            <tr>
                <td>{{ m.hora_administracion.strftime('%d/%m %H:%M') }}</td>
                <td>{{ m.medicamento.nombre }}</td>
                <td>{{ m.cantidad }} {{ m.unidad }}</td>
                <td class="no-print">
                    {% if puede_editar_turno_template(m) %}
                        <a href="{{ url_for('enfermeria.editar_administracion_med', admin_id=m.id) }}" class="btn-verde-folio">Editar</a>
                        <form action="{{ url_for('enfermeria.eliminar_administracion_medicamento', admin_id=m.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Eliminar dosis?')">
                            <button type="submit" class="btn-rojo-folio">X</button>
                        </form>
                    {% else %}<span class="text-bloqueado">Bloqueado</span>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="seccion-negra">Insumos y Materiales</div>
<table>
    <thead>
        <tr>
            <th style="width: 10%;">ESTADO</th>
            <th>INSUMO</th>
            <th style="width: 8%;">CANT.</th>
            <th>FECHA/OBSERVACIÓN</th>
            <th class="no-print" style="width: 15%;">ACCIÓN</th>
        </tr>
    </thead>
    <tbody>
        {# 1. Insumos USADOS #}
        {% for ins in insumos_registrados %}
        <tr style="background-color: #f9f9f9;">
            <td><strong>USADO</strong></td>
            <td>{{ ins.nombre }}</td>
            <td>{{ ins.usado }}</td>
            <td>{{ ins.fecha_uso }} - {{ ins.observaciones or '' }}</td>
            <td class="no-print">
    {# Comparamos la fecha del insumo con la fecha actual del servidor #}
    {% set fecha_hoy = ahora_bogota().strftime('%Y-%m-%d') %}
    {% set fecha_insumo = ins.fecha_uso.split(' ')[0] if ins.fecha_uso else '' %}

    {% if fecha_insumo == fecha_hoy %}
        <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}" class="btn-verde-folio">Editar</a>
    {% else %}
        <span class="text-bloqueado">Cerrado</span>
    {% endif %}
</td>
        </tr>
        {% endfor %}

        {# 2. Insumos PENDIENTES #}
        {% for pen in insumos_pendientes %}
        <tr>
            <td style="color: #5f5f5f;">PENDIENTE</td>
            <td>{{ pen.nombre }}</td>
            <td>{{ pen.solicitado }}</td>
            <td>Solicitado: {{ pen.fecha_solicitud }}</td>
            <td class="no-print">
                <a href="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}" class="btn-verde-folio">Gestionar</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

    <div class="seccion-negra">Notas de Evolución</div>
    {% for r in registros %}
        {% if r.texto_nota %}
        <div style="border: 1px solid #000; margin-top: 5px; page-break-inside: avoid;">
            <div style="background-color: var(--bg-containers); padding: 5px; border-bottom: 1px solid #000; display: flex; justify-content: space-between;">
                <strong>{{ r.fecha_registro.strftime('%d/%m/%Y %H:%M') }} - {{ r.tipo_nota }}</strong>
                <span class="no-print">
                    {% if puede_editar_turno_template(r) %}
                        <a href="{{ url_for('enfermeria.editar_nota', registro_id=r.id) }}" class="btn-verde-folio">Editar</a>
                        <form action="{{ url_for('enfermeria.eliminar_nota_enfermeria', registro_id=r.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Eliminar nota?')">
                            <button type="submit" class="btn-rojo-folio">X</button>
                        </form>
                    {% else %}<span class="text-bloqueado">Bloqueado</span>{% endif %}
                </span>
            </div>
            <div style="padding: 10px; white-space: pre-wrap;">{{ r.texto_nota }}</div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}