{% extends "base.html" %}

{% block title %}Historial Clínico - {{ paciente.nombre_completo }}{% endblock %}

{% block head %}
<style>
    :root {
      --bg-app: #f75ba0;          /* Fondo: hf75ba */
      --bg-containers: #f0e7d8;   /* Interior de contenedores */
      --titles: #236e7b;          /* Títulos */
      --text-links: #0b6169;      /* Textos y links */
      --verde-btn: #28a745;       /* Botones principales verdes */
      --secondary: #5f5f5f;
    }

    body { 
        background-color: var(--bg-app) !important; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container-clinica {
        background-color: var(--bg-containers);
        border-radius: 25px;
        padding: 40px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        margin-bottom: 50px;
    }

    /* Tarjetas Mejoradas */
    .card-registro {
        background: white;
        border: none;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .card-registro-header {
        background-color: #ffffff;
        padding: 15px 20px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-registro-body { padding: 20px; }

    /* Indicadores de Categoría */
    .border-sv { border-left: 6px solid #007bff; }
    .border-liq { border-left: 6px solid #17a2b8; }
    .border-nota { border-left: 6px solid #6f42c1; }
    .border-med { border-left: 6px solid #fd7e14; }
    .border-ins { border-left: 6px solid var(--verde-btn); }

    /* Grid de Signos Vitales */
    .sv-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .sv-box {
        flex: 1;
        min-width: 100px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 10px;
        text-align: center;
    }
    .sv-box label { font-size: 0.7rem; color: var(--secondary); display: block; margin-bottom: 2px; }
    .sv-box span { font-size: 1rem; font-weight: 700; color: var(--titles); }

    /* Estilo Balance de Líquidos */
    .liq-section {
        display: flex;
        gap: 20px;
        margin-top: 10px;
    }
    .liq-item {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
    }
    .liq-adm { background-color: #e3f2fd; border: 1px solid #bbdefb; }
    .liq-elim { background-color: #ffebee; border: 1px solid #ffcdd2; }

    /* Botón Verde solicitado */
    .btn-edit-circular {
        width: 42px; height: 42px;
        border-radius: 50%;
        background-color: var(--verde-btn);
        color: white !important;
        display: flex; align-items: center; justify-content: center;
        transition: 0.3s; border: none;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
    }
    .btn-edit-circular:hover { transform: scale(1.1); background-color: #218838; }

    .titulo-seccion { 
        color: var(--titles); font-weight: 850; 
        margin: 45px 0 20px 0; border-left: 4px solid var(--titles); padding-left: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="container-clinica">
        
        <div class="row align-items-center mb-5">
            <div class="col-md-7">
                <h1 style="color: var(--titles); font-weight: 900; margin: 0;">HISTORIAL CLÍNICO</h1>
                <p class="text-muted mb-0"><i class="fas fa-calendar-alt me-2"></i> Reporte generado el {{ now.strftime('%d/%m/%Y') if now else '' }}</p>
            </div>
            <div class="col-md-5 text-md-end">
                <div style="background: white; padding: 15px 25px; border-radius: 15px; border: 2px solid var(--titles); display: inline-block;">
                    <small class="d-block text-uppercase fw-bold text-muted">Paciente:</small>
                    <span class="h5 mb-0 fw-bold" style="color: var(--titles);">{{ paciente.nombre_completo }}</span>
                </div>
            </div>
        </div>

        <h4 class="titulo-seccion">MONITOREO DE SIGNOS VITALES</h4>
        {% for r in registros %}
            {% set sv = r.signos_vitales_dict or {} %}
            {% if sv.ta or sv.fc or sv.temp or r.control_glicemia %}
            <div class="card card-registro border-sv">
                <div class="card-registro-header">
                    <span class="fw-bold"><i class="far fa-clock me-2"></i>{{ r.fecha_registro.strftime('%d/%m/%y - %H:%M') }}</span>
                    <a href="{{ url_for('enfermeria.editar_signos', registro_id=r.id) }}" class="btn-edit-circular" title="Editar Signos">
                        <i class="fas fa-pen-nib"></i>
                    </a>
                </div>
                <div class="card-registro-body">
                    <div class="sv-container">
                        <div class="sv-box"><label>T. Arterial</label><span>{{ sv.ta or '--' }}</span></div>
                        <div class="sv-box"><label>F. Cardíaca</label><span>{{ sv.fc or '--' }} <small>bpm</small></span></div>
                        <div class="sv-box"><label>F. Resp.</label><span>{{ sv.fr or '--' }} <small>rpm</small></span></div>
                        <div class="sv-box"><label>Temp.</label><span>{{ sv.temp or '--' }}°C</span></div>
                        <div class="sv-box"><label>SatO2</label><span>{{ sv.so2 or '--' }}%</span></div>
                        <div class="sv-box" style="background: #fff3cd;"><label>Glicemia</label><span>{{ r.control_glicemia or '--' }}</span></div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <h4 class="titulo-seccion">CONTROL DE LÍQUIDOS (INGESTA/ELIMINACIÓN)</h4>
        {% for r in registros %}
            {% set liq = r.balance_liquidos_dict or {} %}
            {% if liq.administrados or liq.eliminados %}
            <div class="card card-registro border-liq">
                <div class="card-registro-header">
                    <span class="fw-bold text-info"><i class="fas fa-tint me-2"></i>Balance del {{ r.fecha_registro.strftime('%H:%M') }}</span>
                    <a href="{{ url_for('enfermeria.editar_balance', registro_id=r.id) }}" class="btn-edit-circular">
                        <i class="fas fa-fill-drip"></i>
                    </a>
                </div>
                <div class="card-registro-body">
                    <div class="liq-section">
                        <div class="liq-item liq-adm">
                            <small class="fw-bold text-primary text-uppercase">Administrado</small>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <span>{{ liq.administrados.liquido or 'N/A' }} ({{ liq.administrados.via or '-' }})</span>
                                <span class="h5 mb-0 fw-bold">{{ liq.administrados.cantidad or '0' }}cc</span>
                            </div>
                        </div>
                        <div class="liq-item liq-elim">
                            <small class="fw-bold text-danger text-uppercase">Eliminado</small>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <span>{{ liq.eliminados.tipo_liquido or 'N/A' }} ({{ liq.eliminados.via_eliminacion or '-' }})</span>
                                <span class="h5 mb-0 fw-bold">{{ liq.eliminados.cantidad or '0' }}cc</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <h4 class="titulo-seccion">NOTAS DE ENFERMERÍA</h4>
        <div class="row">
            {% for r in registros %}
                {% if r.tipo_nota and r.texto_nota %}
                <div class="col-md-12">
                    <div class="card card-registro border-nota">
                        <div class="card-registro-header">
                            <span class="badge" style="background: var(--titles);">{{ r.tipo_nota }}</span>
                            <small class="text-muted">{{ r.fecha_registro.strftime('%d/%m/%y %H:%M') }}</small>
                        </div>
                        <div class="card-body">
                            <p class="mb-0" style="color: var(--text-links); font-size: 0.95rem; line-height: 1.6;">{{ r.texto_nota }}</p>
                        </div>
                        <div class="p-2 text-end">
                            <a href="{{ url_for('enfermeria.editar_nota', registro_id=r.id) }}" class="btn btn-sm text-primary"><i class="fas fa-edit me-1"></i>Editar Nota</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4 class="titulo-seccion">MEDICACIÓN</h4>
                {% for admin in medicamentos %}
                <div class="card card-registro border-med">
                    <div class="p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold" style="color: #fd7e14;">{{ admin.medicamento.nombre }}</div>
                            <small class="text-muted">{{ admin.cantidad }} {{ admin.unidad }} - {{ admin.hora_administracion.strftime('%H:%M') }}</small>
                        </div>
                        <a href="{{ url_for('enfermeria.editar_administracion_med', admin_id=admin.id) }}" class="btn-edit-circular" style="width: 32px; height: 32px;">
                            <i class="fas fa-pills fa-sm"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="col-md-6">
                <h4 class="titulo-seccion">INSUMOS</h4>
                {% for ins in insumos_registrados %}
                <div class="card card-registro border-ins">
                    <div class="p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold" style="color: var(--verde-btn);">{{ ins['nombre'] if ins is mapping else ins.nombre }}</div>
                            <span class="badge bg-success">Cantidad: {{ ins['usado'] if ins is mapping else ins.usado }}</span>
                        </div>
                        {% set id_ins = ins['id'] if ins is mapping else ins.id %}
                        {% if id_ins %}
                        <a href="{{ url_for('enfermeria.editar_insumo_paciente', insumo_paciente_id=id_ins) }}" class="btn-edit-circular" style="width: 32px; height: 32px;">
                            <i class="fas fa-box fa-sm"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="text-center mt-5">
            <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" class="btn btn-lg px-5 shadow" style="background: white; color: var(--titles); border-radius: 50px; font-weight: bold; border: 2px solid var(--titles);">
                <i class="fas fa-arrow-left me-2"></i> REGRESAR AL PANEL
            </a>
        </div>

    </div>
</div>
{% endblock %}