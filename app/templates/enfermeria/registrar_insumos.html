{% extends "base.html" %}
{% block title %}Registrar Insumos - {{ paciente.nombre }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>✅ Registrar uso de insumos - {{ paciente.nombrecompleto }}</h2>

    <form method="POST" action="{{ url_for('enfermeria.registrar_insumos', paciente_id=paciente.id) }}">
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-syringe me-2"></i>Insumos Pendientes ({{ insumos|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-sm mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 4%"></th>
                                <th style="width: 28%">Insumo</th>
                                <th class="text-center" style="width: 12%">Solicitado</th>
                                <th class="text-center" style="width: 12%">Usado</th>
                                <th class="text-center" style="width: 12%">**Disponible**</th>
                                <th class="text-center" style="width: 12%">Cantidad</th>
                                <th class="text-center" style="width: 12%">Estado</th>
                                <th style="width: 28%">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in insumos %}
                            <tr>
                                <td class="text-center">
                                    <input class="form-check-input" type="checkbox" checked
                                           name="insumos_reg[]" value="{{ i.id }}">
                                </td>
                                <td><strong>{{ i.nombre }}</strong></td>
                                <td class="text-center fw-bold">{{ i.solicitado }}</td>
                                <td class="text-center fw-bold">{{ i.usado }}</td>
                                <td class="text-center fw-bold text-info">
                                    {{ i.solicitado - i.usado }}
                                </td>
                                <td class="text-center">
                                    <input type="number" name="cant_{{ i.id }}" 
                                           value="1" min="1" max="{{ i.solicitado - i.usado }}"
                                           class="form-control form-control-sm text-center"
                                           style="width: 80px;">
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning text-dark">
                                        {{ i.solicitado - i.usado }} pendientes
                                    </span>
                                </td>
                                <td>
                                    <textarea name="obs_{{ i.id }}" 
                                              class="form-control" rows="2"
                                              placeholder="Uso del insumo... ej: 'Aplicación IV', 'Curación herida', etc."
                                              maxlength="200" style="resize: vertical;"></textarea>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not insumos %}
                            <tr>
                                <td colspan="8" class="text-center text-muted p-4">
                                    ✅ No hay insumos pendientes para este paciente.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if insumos %}
        <div class="mb-3 p-3 bg-light rounded">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-double me-2"></i> ✅ Registrar todos seleccionados
            </button>
            <a href="{{ url_for('enfermeria.solicitar_insumos', paciente_id=paciente.id) }}"
               class="btn btn-primary btn-lg ms-2">
                ➕ Solicitar más insumos
            </a>
        </div>
        {% else %}
        <div class="text-center p-4 bg-success bg-opacity-10 rounded p-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">¡Todos los insumos están completos!</h5>
            <a href="{{ url_for('enfermeria.solicitar_insumos', paciente_id=paciente.id) }}"
               class="btn btn-primary btn-lg">
                ➕ Solicitar nuevos insumos
            </a>
        </div>
        {% endif %}
    </form>
</div>

<style>
.table th { font-size: 0.85rem; }
.table td { font-size: 0.8rem; vertical-align: middle; }
textarea { font-size: 0.8rem; }
</style>
{% endblock %}
