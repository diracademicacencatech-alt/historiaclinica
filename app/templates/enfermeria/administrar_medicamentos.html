{% extends "base.html" %}

{% block title %}Administraci√≥n de Medicamentos - Software SM{% endblock %}

{% block head %}
<style>
    :root {
      --titles: #236e7b;
      --text-links: #0b6169;
      --text-secondary: #5f5f5f;
      --bg-containers: #f0e7d8;
    }

    .titulo-principal { 
      color: var(--titles); 
      text-align: center; 
      margin-bottom: 30px; 
      font-weight: 800;
      text-transform: uppercase;
    }

    .titulo-seccion {
      color: var(--titles);
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 25px;
      margin-bottom: 15px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-white-box {
      background: #ffffff;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      border-left: 6px solid var(--titles);
    }

    .table-sm-custom {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        border: none;
    }

    .table-sm-custom thead {
        background-color: var(--titles);
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    .btn-sm-verde {
        background-color: var(--titles) !important;
        color: white !important;
        border: none !important;
        font-weight: 700;
        text-transform: uppercase;
        padding: 12px 20px;
        border-radius: 10px;
        transition: all 0.2s;
        display: inline-block;
        text-align: center;
        width: 100%;
    }

    .btn-sm-verde:hover {
        background-color: var(--text-links) !important;
        transform: translateY(-2px);
    }

    .nav-links {
      margin-top: 40px;
      padding-top: 25px;
      border-top: 1px dashed rgba(0,0,0,0.15);
      text-align: center;
    }

    .btn-nav {
      color: var(--text-links);
      text-decoration: none;
      font-weight: 700;
      font-size: 13px;
      padding: 10px 15px;
      text-transform: uppercase;
    }

    .modal-content { border-radius: 15px; border: none; }
    .modal-header { background-color: var(--titles); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container py-2">
    
    <h2 class="titulo-principal">üíä Administraci√≥n de Medicamentos</h2>

    <h5 class="titulo-seccion">üìã Informaci√≥n del Paciente</h5>
    <div class="section-white-box">
        <div class="row">
            <div class="col-md-8 border-end">
                <p><strong>Paciente:</strong> {{ registro.paciente.nombre if registro.paciente else 'N/A' }}</p>
                <p><strong>Identificaci√≥n:</strong> {{ registro.paciente.numero if registro.paciente else 'N/A' }}</p>
            </div>
            <div class="col-md-4 ps-md-4 text-end">
                <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" 
                    class="btn-nav" style="border: 1px solid var(--titles); border-radius: 8px;">
                    ‚Üê Volver a registros
                </a>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h5 class="titulo-seccion">üìã Medicamentos Formulados</h5>
    <div class="table-responsive table-sm-custom mb-4">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-3">Medicamento</th>
                    <th>Dosis</th>
                    <th>Frecuencia</th>
                    <th>V√≠a Orden</th>
                    <th class="text-center">Formulada</th>
                    <th class="text-center">Admin.</th>
                    <th class="text-center">Pendiente</th>
                </tr>
            </thead>
            <tbody>
                {% if medicamentos_formulados %}
                    {% for med in medicamentos_formulados %}
                    <tr>
                        <td class="ps-3"><strong>{{ med.nombre }}</strong><br><small class="text-muted">{{ med.codigo }}</small></td>
                        <td>{{ med.dosis }} {{ med.unidad }}</td>
                        <td>{{ med.frecuencia }}</td>
                        <td><span class="badge bg-light text-dark border">{{ med.via_administracion or med.via }}</span></td>
                        <td class="text-center">{{ med.cantidad_formulada }}</td>
                        <td class="text-center text-success fw-bold">{{ med.cantidad_administrada }}</td>
                        <td class="text-center fw-bold {{ 'text-danger' if med.pendiente > 0 else 'text-muted' }}">
                            {{ med.pendiente if med.pendiente > 0 else '‚úì' }}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="7" class="text-center py-4">No hay medicamentos formulados.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <h5 class="titulo-seccion">‚ûï Registrar Aplicaci√≥n</h5>
    <div class="section-white-box" style="border-left-color: #28a745;">
        {% if medicamentos_formulados %}
        <form method="POST" class="row g-3" id="formAdministracion">
            <div class="col-md-6">
                <label class="form-label fw-bold" style="color: var(--titles);">Medicamento *</label>
                <select name="codigo_medicamento" id="selectMedicamento" class="form-select shadow-sm" required onchange="autoLlenarMedicamento()">
                    <option value="">-- Seleccione del listado --</option>
                    {% for med in medicamentos_formulados %}
                    <option value="{{ med.codigo }}" 
                            data-via="{{ med.via_administracion or med.via }}" 
                            data-unidad="{{ med.unidad }}">
                        {{ med.nombre }} ({{ med.via_administracion or med.via }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Cantidad *</label>
                <input type="number" name="cantidad" step="0.1" min="0.1" class="form-control shadow-sm" required>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">V√≠a de Aplicaci√≥n *</label>
                <select name="via" id="selectVia" class="form-select shadow-sm" required>
                    <option value="VO">VO - V√≠a Oral</option>
                    <option value="IV">IV - Intravenosa</option>
                    <option value="IM">IM - Intramuscular</option>
                    <option value="SC">SC - Subcut√°nea</option>
                    <option value="SL">SL - Sublingual</option>
                    <option value="ID">ID - Intrad√©rmica</option>
                    <option value="OTRA">OTRA</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Fecha y Hora</label>
                <input type="datetime-local" name="hora_administracion" value="{{ hora_actual }}" class="form-control shadow-sm">
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Observaciones / Nota de Enfermer√≠a</label>
                <input type="text" name="observaciones" class="form-control shadow-sm" placeholder="Opcional">
            </div>
            <div class="col-12 mt-4">
                <button type="submit" class="btn-sm-verde shadow">
                    üíæ GUARDAR REGISTRO DE ADMINISTRACI√ìN
                </button>
            </div>
        </form>
        {% else %}
            <div class="text-center py-3 text-muted">No hay medicamentos pendientes para administraci√≥n.</div>
        {% endif %}
    </div>

    <h5 class="titulo-seccion">üïí Historial de Aplicaciones (Turno)</h5>
    <div class="table-responsive table-sm-custom mb-5">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-3">Medicamento</th>
                    <th>Cant.</th>
                    <th>V√≠a</th>
                    <th>Fecha/Hora</th>
                    <th>Observaciones</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {# Ordenamos el historial por hora de administraci√≥n #}
                {% if administraciones %}
                    {% for admin in administraciones|sort(attribute='hora_administracion', reverse=True) %}
                    <tr>
                        <td class="ps-3">
                            <strong>{{ admin.medicamento.nombre if admin.medicamento else 'N/A' }}</strong>
                        </td>
                        <td>{{ admin.cantidad }} {{ admin.unidad or '' }}</td>
                        <td><span class="badge bg-info text-dark">{{ admin.via }}</span></td>
                        <td>{{ admin.hora_administracion.strftime('%H:%M') }} <small class="text-muted">{{ admin.hora_administracion.strftime('%d/%m') }}</small></td>
                        <td class="small text-muted">{{ admin.observaciones or '---' }}</td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditar{{ admin.id }}">‚úèÔ∏è</button>
                                <form method="POST" action="{{ url_for('enfermeria.eliminar_administracion_medicamento', admin_id=admin.id) }}" onsubmit="return confirm('¬øEliminar registro?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6" class="text-center py-4">Sin aplicaciones registradas a√∫n en este turno.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="nav-links">
        <a href="{{ url_for('menu.inicio') }}" class="btn-nav">Ir al Inicio Principal</a>
        <span class="separator">|</span>
        <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" class="btn-nav">Volver al Paciente</a>
    </div>
</div>

{# MODALES DE EDICI√ìN #}
{% for admin in administraciones %}
<div class="modal fade" id="modalEditar{{ admin.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{{ url_for('enfermeria.editar_administracion_medicamento', admin_id=admin.id) }}" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Aplicaci√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Cantidad</label>
                    <input type="number" name="cantidad" value="{{ admin.cantidad }}" step="0.1" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Observaciones</label>
                    <textarea name="observaciones" class="form-control" rows="2">{{ admin.observaciones }}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" class="btn-sm-verde" style="width: auto;">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<script>
function autoLlenarMedicamento() {
    const sel = document.getElementById('selectMedicamento');
    const opt = sel.options[sel.selectedIndex];
    const selectVia = document.getElementById('selectVia');
    
    if (opt && opt.value !== "") {
        // Obtenemos la v√≠a que viene de la orden (ej: "INTRAVENOSA" o "ORAL")
        const viaOrden = opt.dataset.via ? opt.dataset.via.trim().toUpperCase() : "";
        
        if (viaOrden) {
            // Mapeo inteligente para reconocer t√©rminos comunes
            for (let i = 0; i < selectVia.options.length; i++) {
                const valorOpcion = selectVia.options[i].value.toUpperCase(); // Ej: "IV", "VO"
                const textoOpcion = selectVia.options[i].text.toUpperCase();  // Ej: "INTRAVENOSA", "V√çA ORAL"

                // Si la v√≠a de la orden coincide con el c√≥digo (IV) o con el texto (INTRAVENOSA)
                if (viaOrden === valorOpcion || 
                    textoOpcion.includes(viaOrden) || 
                    viaOrden.includes(valorOpcion) ||
                    (viaOrden === "INTRAVENOSA" && valorOpcion === "IV") ||
                    (viaOrden === "ORAL" && valorOpcion === "VO")) {
                    
                    selectVia.selectedIndex = i;
                    return;
                }
            }
        }
    }
}
</script>
{% endblock %}