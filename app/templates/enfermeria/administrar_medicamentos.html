{% extends "base.html" %}

{% block title %}Administraci√≥n de Medicamentos - Software SM{% endblock %}

{% block head %}
<style>
    :root {
      --titles: #236e7b;
      --text-links: #0b6169;
      --text-secondary: #5f5f5f;
      --bg-containers: #f0e7d8;
      --sm-bg-principal: #ffffff; /* Fondo Blanco */
    }

    footer, body > footer, .navbar + footer {
        display: none !important;
    }

    body { background-color: var(--sm-bg-principal) !important; }

    .titulo-principal { 
      color: var(--titles); 
      text-align: center; 
      margin-bottom: 30px; 
      font-weight: 800;
      text-transform: uppercase;
    }

    .titulo-seccion {
      color: var(--titles);
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 25px;
      margin-bottom: 15px;
      text-transform: uppercase;
      display: flex; align-items: center; gap: 10px;
    }

    .section-white-box {
      background: #ffffff;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      border-left: 6px solid var(--titles);
    }

    .table-sm-custom {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        border: 1px solid #eee;
    }

    .table-sm-custom thead {
        background-color: var(--titles);
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    /* Bot√≥n verde principal solicitado */
    .btn-sm-verde {
        background-color: #28a745 !important;
        color: white !important;
        border: none !important;
        font-weight: 700;
        text-transform: uppercase;
        padding: 12px 20px;
        border-radius: 10px;
        transition: all 0.2s;
        display: inline-block;
        text-align: center; 
        width: 100%;
    }

    .btn-sm-verde:hover {
        background-color: #218838 !important;
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-2">
    
    <h2 class="titulo-principal">üíä Administraci√≥n de Medicamentos</h2>

    <h5 class="titulo-seccion">üìã Informaci√≥n del Paciente</h5>
    <div class="section-white-box">
        <div class="row align-items-center">
            <div class="col-md-8">
                <p class="mb-1"><strong>Paciente:</strong> {{ registro.paciente.nombre if registro.paciente else 'N/A' }}</p>
                <p class="mb-0"><strong>Identificaci√≥n:</strong> {{ registro.paciente.numero if registro.paciente else 'N/A' }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('enfermeria.menu_paciente', paciente_id=paciente.id) }}" 
                    class="btn btn-outline-primary btn-sm fw-bold px-3" style="border-radius: 8px; text-transform: uppercase;">
                    ‚Üê Volver a registros
                </a>
            </div>
        </div>
    </div>

    <h5 class="titulo-seccion">üìã Medicamentos Formulados</h5>
    <div class="table-responsive table-sm-custom mb-4">
    <table class="table table-hover align-middle mb-0">
        <thead>
            <tr>
                <th class="ps-3">Medicamento</th>
                <th>Dosis</th>
                <th>Frecuencia</th> <th>V√≠a Orden</th>
                <th class="text-center">Formulada</th>
                <th class="text-center">Admin.</th>
                <th class="text-center">Pendiente</th>
            </tr>
        </thead>
        <tbody>
            {% for med in medicamentos_formulados %}
            <tr>
                <td class="ps-3">
                    <strong>{{ med.nombre }}</strong><br>
                    <small class="text-muted">{{ med.codigo }}</small>
                </td>
                <td>{{ med.dosis }}</td>
                
                <td class="fw-bold" style="color: #0b6169; text-transform: capitalize;">
    {{ med.frecuencia }}
</td>
                
                <td>
                    <span class="badge bg-light text-dark border">
                        {{ med.via if med.via else 'VO' }}
                    </span>
                </td>
                <td class="text-center">{{ med.cantidad_formulada }}</td>
                <td class="text-center text-success fw-bold">{{ med.cantidad_administrada | float }}</td>
                <td class="text-center fw-bold {{ 'text-danger' if med.pendiente > 0 else 'text-muted' }}">
                    {{ med.pendiente if med.pendiente > 0 else '‚úì' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

    <h5 class="titulo-seccion">‚ûï Registrar Aplicaci√≥n</h5>
    <div class="section-white-box" style="border-left-color: #28a745;">
        {% if medicamentos_formulados %}
        <form method="POST" class="row g-3" id="formAdministracion">
            <div class="col-md-6">
                <label class="form-label fw-bold" style="color: var(--titles);">Medicamento *</label>
                <select name="codigo_medicamento" id="selectMedicamento" class="form-select shadow-sm" required onchange="autoLlenarMedicamento()">
                    <option value="">-- Seleccione del listado --</option>
                    {% for med in medicamentos_formulados %}
                    <option value="{{ med.codigo }}" 
                            data-via="{{ med.via }}" 
                            data-unidad="{{ med.unidad_inventario }}">
                        {{ med.nombre }} ({{ med.via }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Cantidad *</label>
                <input type="number" name="cantidad" step="0.1" min="0.1" class="form-control shadow-sm" required>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">V√≠a de Aplicaci√≥n *</label>
                <select name="via" id="selectVia" class="form-select shadow-sm" required>
                    <option value="VO">VO - V√≠a Oral</option>
                    <option value="IV">IV - Intravenosa</option>
                    <option value="IM">IM - Intramuscular</option>
                    <option value="SC">SC - Subcut√°nea</option>
                    <option value="SL">SL - Sublingual</option>
                    <option value="ID">ID - Intrad√©rmica</option>
                    <option value="OTRA">OTRA</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Hora de Aplicaci√≥n *</label>
                <input type="time" name="hora_admin" id="hora_admin" class="form-control shadow-sm" required>
            </div>
            <div class="col-md-8">
                <label class="form-label fw-bold">Observaciones / Nota de Enfermer√≠a</label>
                <input type="text" name="observaciones" class="form-control shadow-sm" placeholder="Opcional">
            </div>
            <div class="col-12 mt-4">
                <button type="submit" class="btn-sm-verde shadow">
                    üíæ GUARDAR REGISTRO DE ADMINISTRACI√ìN
                </button>
            </div>
        </form>
        {% endif %}
    </div>

    <h5 class="titulo-seccion">üïí Historial de Aplicaciones (Turno)</h5>
    <div class="table-responsive table-sm-custom mb-5">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-3">Medicamento</th>
                    <th>Cant.</th>
                    <th>V√≠a</th>
                    <th>Hora</th>
                    <th>Observaciones</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if administraciones %}
                    {% for admin in administraciones|sort(attribute='hora_administracion', reverse=True) %}
                    <tr>
                        <td class="ps-3"><strong>{{ admin.medicamento.nombre if admin.medicamento else 'N/A' }}</strong></td>
                        <td>{{ admin.cantidad }} {{ admin.unidad or '' }}</td>
                        <td><span class="badge bg-info text-dark">{{ admin.via }}</span></td>
                        <td class="fw-bold">{{ admin.hora_administracion.strftime('%H:%M') if admin.hora_administracion else 'N/A' }}</td>
                        <td class="small text-muted">{{ admin.observaciones or '---' }}</td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ url_for('enfermeria.editar_administracion_med', admin_id=admin.id) }}" 
                                   class="btn btn-sm btn-outline-primary" title="Editar">‚úèÔ∏è</a>
                                <form method="POST" action="{{ url_for('enfermeria.eliminar_administracion_medicamento', admin_id=admin.id) }}" 
                                      onsubmit="return confirm('¬øEliminar registro?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6" class="text-center py-4">Sin aplicaciones registradas a√∫n.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ahora = new Date();
    const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + ahora.getMinutes().toString().padStart(2, '0');
    const inputHora = document.getElementById('hora_admin');
    if(inputHora) inputHora.value = horaActual;
});

function autoLlenarMedicamento() {
    const sel = document.getElementById('selectMedicamento');
    const opt = sel.options[sel.selectedIndex];
    const selectVia = document.getElementById('selectVia');
    
    if (opt && opt.value !== "") {
        const viaOrden = opt.dataset.via ? opt.dataset.via.trim().toUpperCase() : "";
        if (viaOrden) {
            for (let i = 0; i < selectVia.options.length; i++) {
                const valorOpcion = selectVia.options[i].value.toUpperCase();
                // Si la v√≠a de la orden coincide con la opci√≥n del select
                if (viaOrden === valorOpcion || viaOrden.includes(valorOpcion)) {
                    selectVia.selectedIndex = i;
                    break;
                }
            }
        }
    }
}
</script>
{% endblock %}