{% extends "base.html" %}
{% block title %}Registros de enfermería{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 col-lg-6 mb-3">

    <h2 class="sm-main-title">Registros de enfermería</h2>
    <p class="sm-main-subtitle">
      Buscar paciente por documento, nombre o ingreso para ver o crear registros.
    </p>

    <div class="card">
      <div class="card-header">Buscar paciente</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('enfermeria.inicio_enfermeria') }}">
          <div class="mb-3 position-relative">
            <label for="criterio" class="form-label">Documento, nombre o número de ingreso</label>
            <input type="text" id="criterio" name="criterio"
                   class="form-control"
                   autocomplete="off"
                   placeholder="Ej: 12345, Juan Pérez..." required>
            <div id="sugerencias"
                 class="list-group position-absolute w-100"
                 style="z-index: 1000;"></div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            Buscar
          </button>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('criterio');
  const contenedor = document.getElementById('sugerencias');

  let ultimoTermino = '';
  let timeoutId = null;

  if (!input || !contenedor) return;

  function limpiarSugerencias() {
    while (contenedor.firstChild) contenedor.removeChild(contenedor.firstChild);
  }

  input.addEventListener('input', function () {
    const termino = input.value.trim();

    if (termino.length < 2 || termino === ultimoTermino) {
      limpiarSugerencias();
      return;
    }
    ultimoTermino = termino;

    if (timeoutId) clearTimeout(timeoutId);

    timeoutId = setTimeout(function () {
      fetch('{{ url_for("enfermeria.autocomplete_pacientes") }}?q=' + encodeURIComponent(termino))
        .then(resp => resp.json())
        .then(function (datos) {
          limpiarSugerencias();
          datos.forEach(function (p) {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = p.nombre + ' (' + p.numero + ')';
            item.addEventListener('click', function () {
              // mandamos al backend el número del paciente
              input.value = p.numero;
              limpiarSugerencias();
            });
            contenedor.appendChild(item);
          });
        })
        .catch(function () {
          limpiarSugerencias();
        });
    }, 250);
  });

  input.addEventListener('blur', function () {
    setTimeout(limpiarSugerencias, 200);
  });
});
</script>
{% endblock %}
