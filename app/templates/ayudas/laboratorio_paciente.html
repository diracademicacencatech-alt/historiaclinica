{% extends "base.html" %}

{% block title %}Simulaci√≥n de Laboratorios - {{ historia.paciente.nombre }}{% endblock %}

{% block head %}
<style>
    /* Estilos de la paleta personalizada */
    .sm-page-title { color: #236e7b; font-weight: 800; text-transform: uppercase; text-align: center; }
    
    /* Botones Verdes (Primarios) */
    .btn-sm-green {
        background-color: #236e7b; /* Verde est√°ndar m√©dico */
        color: white !important;
        border: none;
        font-weight: 700;
        transition: all 0.3s;
    }
    .btn-sm-green:hover {
        background-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn-simulate {
        background-color: #236e7b;
        color: white; border: none; padding: 8px 15px; border-radius: 8px;
        font-weight: 600; transition: all 0.3s;
    }
    .btn-simulate:hover { background-color: #236e7b; transform: scale(1.05); }
    
    .resultado-alterado {
        color: #d9534f !important;
        font-weight: 800 !important;
        border: 2px solid #d9534f !important;
    }

    .lab-header-row { cursor: pointer; background-color: #ffffff; }
    .detalle-laboratorio { background-color: #fcfcfc; border-left: 4px solid #236e7b; }
    
    /* Estilo del Modal */
    .modal {
        display: none; position: fixed; z-index: 2000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content { background: #f0e7d8; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h2 class="sm-page-title m-0">üìä Gesti√≥n de Resultados</h2>
        
        <div class="d-flex gap-2">
            <a href="{{ url_for('ayudas.generar_pdf_laboratorio', historia_id=historia.id) }}" 
               class="btn btn-sm-green d-flex align-items-center gap-2 px-3 shadow-sm" 
               style="border-radius: 8px;" target="_blank">
                <span>üìÑ</span> PDF Informe
            </a>

            <button type="button" class="btn-simulate shadow-sm" onclick="simularResultados()">
                ‚ö° Simular Resultados
            </button>
        </div>
    </div>

    <form method="POST" id="formResultados">
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead style="background-color: #236e7b; color: white;">
                        <tr>
                            <th class="ps-4">Examen / Laboratorio</th>
                            <th class="text-end pe-4">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for bloque in items_con_parametros %}
                        <tr class="lab-header-row" data-bs-toggle="collapse" data-bs-target="#detalle-{{ loop.index }}">
                            <td class="ps-4">
                                <span class="fw-bold" style="color: #0b6169;">üß™ {{ bloque.examen.nombre }}</span>
                            </td>
                            <td class="text-end pe-4">Ver par√°metros ‚ñæ</td>
                        </tr>

                        <tr class="collapse detalle-laboratorio" id="detalle-{{ loop.index }}">
                            <td colspan="2" class="px-4 py-3">
                                <table class="table table-sm table-bordered bg-white">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Par√°metro</th>
                                            <th>Referencia</th>
                                            <th>Resultado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in bloque.parametros %}
                                            {% set res = bloque.resultados.get(p.id) %}
                                            <tr class="fila-parametro" 
                                                data-min="{{ p.valor_ref_min if p.valor_ref_min is not none else '' }}"
                                                data-max="{{ p.valor_ref_max if p.valor_ref_max is not none else '' }}">
                                                <td>{{ p.nombre }}</td>
                                                <td class="small text-muted">{{ p.valor_ref_min or '0' }} - {{ p.valor_ref_max or 'N/A' }}</td>
                                                <td>
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control resultado-input" 
                                                               id="resultado-{{ p.id }}" 
                                                               value="{{ res.valor if res else '' }}" readonly>
                                                        <button type="button" class="btn btn-outline-secondary btn-edit-js"
                                                                onclick="abrirModal('{{ p.id }}', '{{ p.nombre }}', document.getElementById('resultado-{{ p.id }}').value)">
                                                            ‚úèÔ∏è
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-4" style="width: 100%;">
    <button type="submit" 
            style="width: 100%; height: 55px; background-color: #236e7b; color: white; font-size: 16px; font-weight: bold; margin-bottom: 12px; border: none; border-radius: 5px; display: block; cursor: pointer; text-transform: uppercase;">
        üíæ CONFIRMAR Y GUARDAR TODO EL REPORTE
    </button>
</div>

</form> <div style="width: 100%;">
    <a href="{{ url_for('ayudas.menu_ayudas_historia', historia_id=historia.id) }}" 
       style="width: 100%; height: 55px; background-color: #236e7b; color: white; line-height: 55px; font-size: 16px; font-weight: bold; text-decoration: none; display: block; border: none; border-radius: 5px; text-align: center; text-transform: uppercase;">
        ‚Üê VOLVER AL MEN√ö DE AYUDAS
    </a>
</div>
</div>
<div id="modalEditar" class="modal">
    <div class="modal-content shadow-lg">
        <h5 style="color: #236e7b;" id="modalParametro">Editar Par√°metro</h5>
        <hr>
        <div class="mb-3">
            <label class="form-label font-weight-bold">Nuevo Valor:</label>
            <input type="text" id="modalInput" class="form-control form-control-lg">
        </div>
        <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
            <button type="button" class="btn btn-sm-green px-4" onclick="aplicarCambioModal()">Aplicar</button>
        </div>
    </div>
</div>

<script>
let parametroIdActual = null;

function abrirModal(id, nombre, valor) {
    parametroIdActual = id;
    document.getElementById('modalParametro').innerText = 'Editar: ' + nombre;
    document.getElementById('modalInput').value = valor;
    document.getElementById('modalEditar').classList.add('active');
    setTimeout(() => document.getElementById('modalInput').focus(), 200);
}

function cerrarModal() {
    document.getElementById('modalEditar').classList.remove('active');
    parametroIdActual = null;
}

function aplicarCambioModal() {
    const nuevoValor = document.getElementById('modalInput').value;
    const inputTabla = document.getElementById('resultado-' + parametroIdActual);
    if (inputTabla) {
        inputTabla.value = nuevoValor;
        inputTabla.classList.remove('resultado-alterado');
    }
    cerrarModal();
}

function simularResultados() {
    const filas = document.querySelectorAll('.fila-parametro');
    filas.forEach(fila => {
        const min = parseFloat(fila.getAttribute('data-min'));
        const max = parseFloat(fila.getAttribute('data-max'));
        const input = fila.querySelector('.resultado-input');
        
        if (!isNaN(min) && !isNaN(max)) {
            const esAlterado = Math.random() < 0.20;
            let valor;
            if (esAlterado) {
                valor = (Math.random() > 0.5) ? (max + (Math.random() * 2)).toFixed(2) : (min - (Math.random() * 2)).toFixed(2);
                input.classList.add('resultado-alterado');
            } else {
                valor = (Math.random() * (max - min) + min).toFixed(2);
                input.classList.remove('resultado-alterado');
            }
            input.value = valor;
        }
    });
}

document.getElementById('formResultados').addEventListener('submit', function(e) {
    document.querySelectorAll('.resultado-input').forEach((input) => {
        const pId = input.id.replace('resultado-', '');
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'resultado[' + pId + ']';
        hidden.value = input.value;
        this.appendChild(hidden);
    });
});
</script>
{% endblock %}