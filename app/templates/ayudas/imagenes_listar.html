<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Imágenes diagnósticas - Ayudas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Imágenes diagnósticas</h3>

  <p class="mb-3">
    Paciente: <strong>{{ paciente.nombre }}</strong><br>
    Número: <strong>{{ paciente.numero }}</strong><br>
    Cama: <strong>{{ paciente.cama or '-' }}</strong><br>
    Historia: <strong>{{ historia.numero_historia }}</strong>
  </p>

  <!-- Tabla principal -->
  <div class="card mb-4">
    <div class="card-header">Estudios registrados</div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 25%;">Examen</th>
            <th style="width: 15%;">Fecha último resultado</th>
            <th style="width: 40%;">Observaciones</th>
            <th style="width: 20%;">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% if examenes %}
          {% for e in examenes %}
            <tr>
              <td>{{ e.nombre_examen }}</td>
              <td>
                {% if e.fecha_resultado %}
                  {{ e.fecha_resultado.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
  <form method="post">
    <input type="hidden" name="ayuda_id" value="{{ e.id }}">
    <textarea name="observaciones"
              class="form-control form-control-sm mb-1"
              rows="2"
              style="resize: vertical;"
              placeholder="Escriba observaciones">{{ e.observaciones or '' }}</textarea>
    <button type="submit" class="btn btn-sm btn-outline-secondary">
      Guardar
    </button>
  </form>
</td>
              <td class="text-nowrap">
                {% if e.archivo %}
                  <a href="{{ url_for('ayudas.ver_archivo_ayuda', ayuda_id=e.id) }}"
                     class="btn btn-sm btn-outline-primary" target="_blank">
                    Visualizar
                  </a>
                {% endif %}
                <form action="{{ url_for('ayudas.eliminar_ayuda', ayuda_id=e.id) }}"
                      method="post" class="d-inline"
                      onsubmit="return confirm('¿Seguro que desea eliminar este registro?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    Eliminar
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">
              No hay estudios de imágenes registrados para esta historia.
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Formulario: nuevo estudio individual -->
  <div class="card mb-4">
    <div class="card-header">Agregar estudio individual</div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="nombre_examen" class="form-label">Nombre del examen</label>
            <input type="text" id="nombre_examen" name="nombre_examen" class="form-control" required>
          </div>
          <div class="col-md-3 mb-3">
            <label for="fecha_resultado" class="form-label">Fecha del resultado</label>
            <input type="date" id="fecha_resultado" name="fecha_resultado" class="form-control">
          </div>
          <div class="col-md-5 mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <input type="text" id="observaciones" name="observaciones" class="form-control"
                   placeholder="Opcional">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="archivo" class="form-label">Archivo (imagen, PDF, etc.) opcional</label>
            <input type="file" id="archivo" name="archivo" class="form-control">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Guardar estudio</button>
      </form>
    </div>
  </div>

  <a href="{{ url_for('ayudas.menu_ayudas_historia', historia_id=historia.id) }}" class="btn btn-link">
    &larr; Volver al menú de ayudas
  </a>
</div>
</body>
</html>
